window.BellaAIVoiceWS=null,window.BellaAIVoiceActive=!1,window.BellaAISeenAudio=window.BellaAISeenAudio||new Set,window.BellaAIEarlyAudioBuffer=[],window.BellaAISpeakingFrames=0,window.BellaAIVoiceChatAudio={q:[],audioCtx:null,playing:!1,currentSrc:null,currentGain:null,paused:!1,agentSpeaking:!1,_resumeTimeout:null,_lastB64:null,enqueue(e,t){t?(this.audioCtx=t,this.q.push(e),console.log("[BellaAI][AUDIO] Enqueued audio chunk. Queue length:",this.q.length),this.playing||this.paused||this._playNext()):console.warn("[BellaAI][AUDIO] enqueue: No audio context provided")},_playNext(){if(this.paused)return void console.log("[BellaAI][AUDIO] _playNext: Paused, not playing next chunk");if(window.BellaAITranscriptTracking.abortCurrentResponse)return console.log("[BellaAI][AUDIO] _playNext: Aborting due to interrupt flag"),void this.stop();const e=this.q.shift();if(!e)return this.playing=!1,this.currentSrc=null,this.agentSpeaking=!1,void console.log("[BellaAI][AUDIO] _playNext: Queue empty, agent done speaking");this.playing=!0,console.log("[BellaAI][AUDIO] _playNext: Decoding and playing next chunk"),this._decodeAndBuffer(e,this.audioCtx).then((e=>{if(!this.audioCtx||"closed"===this.audioCtx.state)return console.error("[BellaAI][AUDIO] AudioContext is closed, cannot play audio"),void(this.playing=!1);if(this.currentSrc){try{this.currentSrc.stop(0)}catch(e){}try{this.currentSrc.disconnect()}catch(e){}this.currentSrc=null}const t=this.audioCtx.createBufferSource();t.buffer=e;const n=this.audioCtx.createGain();n.gain.value=1,t.connect(n),n.connect(this.audioCtx.destination),this.currentSrc=t,this.agentSpeaking=!0,console.log("[BellaAI][AUDIO] Starting audio playback, buffer length:",e.length),t.onended=()=>{console.log("[BellaAI][AUDIO] Audio playback ended"),this.agentSpeaking=!1,this.currentSrc=null,this._playNext()};try{t.start(0),console.log("[BellaAI][AUDIO] Audio playback started")}catch(e){console.error("[BellaAI][AUDIO] Error starting audio source:",e),this.currentSrc=null,this.agentSpeaking=!1,this._playNext()}})).catch((e=>{console.error("[BellaAI][AUDIO] Error decoding/playing audio:",e),this.currentSrc=null,this._playNext()}))},_decodeAndBuffer(e,t){return this._lastB64=e,console.log("[BellaAI] Decoding audio chunk, length:",e.length),new Promise(((n,o)=>{try{if(!e||e.length<100)return console.error("[BellaAI] Invalid base64 data in _decodeAndBuffer:",e.length),void o(new Error("Invalid base64 data"));if(!t||"closed"===t.state)return console.error("[BellaAI] Invalid or closed audio context"),void o(new Error("Invalid audio context"));const a=atob(e);console.log("[BellaAI] Decoded binary length:",a.length);const i=new ArrayBuffer(a.length),r=new Uint8Array(i);for(let e=0;e<a.length;e++)r[e]=a.charCodeAt(e);const s=new Int16Array(Math.floor(r.length/2));for(let e=0,t=0;e<r.length-1;e+=2,t++)s[t]=255&r[e]|(255&r[e+1])<<8;console.log("[BellaAI] Created Int16Array with",s.length,"samples");const l=t.createBuffer(1,s.length,16e3),c=l.getChannelData(0);for(let e=0;e<s.length;e++)c[e]=s[e]/32768;console.log("[BellaAI] Successfully created audio buffer"),n(l)}catch(e){console.error("[BellaAI] Error in _decodeAndBuffer:",e),o(e)}}))},pause(){if(this.paused)console.log("[BellaAI][AUDIO] pause: Already paused");else if(this.paused=!0,console.log("[BellaAI][AUDIO] pause: Pausing playback"),this.currentSrc){try{this.currentSrc.stop(0)}catch(e){}this.currentSrc.disconnect(),this.currentSrc.buffer&&this._lastB64&&(this.q.unshift(this._lastB64),console.log("[BellaAI][AUDIO] pause: Pushed last chunk back to queue")),this.currentSrc=null}},resume(){this.paused?(this.paused=!1,console.log("[BellaAI][AUDIO] resume: Resuming playback"),this._playNext()):console.log("[BellaAI][AUDIO] resume: Not paused")},stop(){if(this.currentSrc){try{this.currentSrc.stop(0)}catch(e){}this.currentSrc.disconnect(),this.currentSrc=null,console.log("[BellaAI][AUDIO] stop: Stopped current source")}this.q=[],this.playing=!1,this.paused=!1,this.agentSpeaking=!1,this.audioCtx&&"running"===this.audioCtx.state&&(this.audioCtx.suspend().catch((()=>{})),console.log("[BellaAI][AUDIO] stop: Suspended audio context")),this.audioCtx=null,console.log("[BellaAI][AUDIO] stop: Cleared queue and reset state")}},window.BellaAITranscriptTracking={lastUserTranscriptId:null,lastAgentResponseId:null,processedResponses:new Set,currentConversationId:null,voiceModeAnnounced:!1,defaultGreetingShown:!1,lastResponseText:null,lastAudioId:null,abortCurrentResponse:!1,reset:function(){this.lastUserTranscriptId=null,this.lastAgentResponseId=null,this.processedResponses.clear(),this.currentConversationId=null,this.voiceModeAnnounced=!1,this.defaultGreetingShown=!1,this.lastResponseText=null,this.lastAudioId=null,this.abortCurrentResponse=!1},isResponseProcessed:function(e){return!!e&&(this.processedResponses.has(e)||this.lastAgentResponseId===e)},markResponseProcessed:function(e){e&&(this.lastAgentResponseId=e,this.processedResponses.add(e))}},function(){const e=()=>{try{const e=new(window.AudioContext||window.webkitAudioContext);e.resume().then((()=>e.close())).catch((()=>{})),window.BellaAIVoiceChatAudio&&window.BellaAIVoiceChatAudio.audioCtx&&window.BellaAIVoiceChatAudio.audioCtx.resume().catch((()=>{}))}catch(e){console.log("[BellaAI] Audio context unlock attempt error (non-critical):",e)}};["touchend","touchstart","click","keydown"].forEach((t=>window.addEventListener(t,e,{once:!0,passive:!0})))}(),function(){console.log("ChatVersion:","2.0");let e="";!async function(){try{const t=await fetch("https://api.ipify.org?format=json"),n=await t.json();e=n.ip,console.log("User IP collected for chat")}catch(t){console.error("Error fetching IP:",t),e="unknown"}}();const t={webhook:{url:"",route:""},branding:{logo:"https://cdn-icons-png.flaticon.com/512/5962/5962463.png",name:"Bella : Product Specialist",welcomeText:""},style:{primaryColor:"#003f72",secondaryColor:"#003f72",position:"right",backgroundColor:"#ffffff",fontColor:"#333333"},dealer:{name:"",phone:"",website:"",searchPage:"",provider:""},overtake:!1},n=window.ChatWidgetConfig?{webhook:{...t.webhook,...window.ChatWidgetConfig.webhook},branding:{...t.branding,...window.ChatWidgetConfig.branding},style:{...t.style,...window.ChatWidgetConfig.style},dealer:{...t.dealer,...window.ChatWidgetConfig.dealer},overtake:window.ChatWidgetConfig.overtake||!1,overtakePath:window.ChatWidgetConfig.overtakePath||"/"}:t;if(window.BellaAIChatWidgetInitialized)return;window.BellaAIChatWidgetInitialized=!0;let o=!1;function a(e){try{const t={manuallyClosed:e,timestamp:(new Date).getTime()};localStorage.setItem("bellaaiChatState",JSON.stringify(t))}catch(e){console.error("Error saving chat state:",e)}}function i(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function r(e){if(!e)return"";const t=/<[a-z][\s\S]*>/i.test(e);return e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>'),t||(e=e.replace(/(https?:\/\/[^\s<]+)(?![^<]*>)/g,'<a href="$1" target="_blank">Visit Website</a>')),e=(e=(e=e.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")).replace(/\*([^*]+)\*/g,"<em>$1</em>")).replace(/\n/g,"<br>")}function s(){const e=document.getElementById("thinking-animation");e&&e.remove()}window.initialUtmParameters=function(e){const t={};try{const n=new URL(e),o=new URLSearchParams(n.search),a=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"];a.forEach((function(e){o.has(e)&&(t[e]=o.get(e))}));for(const[e,n]of o.entries())e.startsWith("utm_")&&!a.includes(e)&&(t[e]=n)}catch(e){console.error("Error extracting UTM parameters:",e)}return t}(window.location.href),console.log("Initial UTM Parameters:",window.initialUtmParameters);let l,c="";function d(){if(c)try{const e={sessionId:c,messages:Array.from(k.children).filter((function(e){return e.classList.contains("chat-message")})).map((function(e){return{type:e.classList.contains("user")?"user":"bot",content:e.classList.contains("user")?e.textContent:e.innerHTML}})),inactivityMessageSent:g,promptBubbleShown:f,timestamp:(new Date).getTime(),utmParameters:window.initialUtmParameters||{}};localStorage.setItem("bellaaiChatSession",JSON.stringify(e))}catch(e){console.error("Error saving chat session:",e)}}function u(){try{const e=localStorage.getItem("bellaaiChatSession");if(e){const t=JSON.parse(e),n=(new Date).getTime()-t.timestamp;if(n<864e5)return k.innerHTML="",c=t.sessionId,t.inactivityMessageSent&&(g=!0),t.promptBubbleShown&&(f=!0),t.utmParameters&&(window.initialUtmParameters=t.utmParameters),t.messages&&t.messages.length>0&&t.messages.forEach((function(e){const t=document.createElement("div");t.className="chat-message "+e.type,"user"===e.type?t.textContent=e.content:t.innerHTML=e.content,k.appendChild(t)})),!0;localStorage.removeItem("bellaaiChatSession")}}catch(e){console.error("Error loading saved chat session:",e),localStorage.removeItem("bellaaiChatSession")}return!1}const p=12e4;let h,g=!1;function m(){clearTimeout(l),g||(l=setTimeout((function(){if(v.classList.contains("open")&&c){const e=document.createElement("div");e.className="chat-message bot",e.innerHTML=r("Do you have any questions I can help with?"),k.appendChild(e),k.scrollTop=k.scrollHeight,g=!0,d()}}),p))}let f=!1;function y(){const e=document.getElementById("prompt-bubble");e&&e.remove()}const w=`.bellaai-chat-widget{--chat--color-primary:${n.style.primaryColor};--chat--color-secondary:${n.style.secondaryColor};font-family:'Geist Sans',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif}.bellaai-chat-widget .chat-container{position:fixed;bottom:20px;right:20px;z-index:2147483647;width:380px;height:600px;background:#ffffff;border-radius:12px !important;box-shadow:0 8px 32px rgba(133,79,255,0.15);border:1px solid rgba(133,79,255,0.2);overflow:hidden;opacity:0;transform-origin:bottom right;transform:scale(0);transition:all 0.3s cubic-bezier(0.4,0,0.2,1);pointer-events:none;display:flex;flex-direction:column;visibility:hidden}@media screen and (max-width:600px){.bellaai-chat-widget .chat-container{width:100%;height:100%;bottom:0;right:0;border-radius:0;box-shadow:none}.bellaai-chat-widget .chat-container.position-left{left:0}}.bellaai-chat-widget .chat-container.position-left{right:auto;left:20px;transform-origin:bottom left}.bellaai-chat-widget .chat-container.open{opacity:1;transform:scale(1);pointer-events:all;visibility:visible}.bellaai-chat-widget .brand-header{padding:16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(133,79,255,0.1);position:relative}.bellaai-chat-widget .close-button{position:absolute;right:16px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;font-size:20px;opacity:0.6}.bellaai-chat-widget .brand-header img{width:32px;height:32px}.bellaai-chat-widget .brand-header span{font-size:18px;font-weight:500}.bellaai-chat-widget .chat-interface{display:flex;flex-direction:column;height:100%}.bellaai-chat-widget .chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column}.bellaai-chat-widget .chat-message{padding:12px 16px;margin:8px 0;border-radius:12px;max-width:80%;word-wrap:break-word;font-size:14px;line-height:1.5}.bellaai-chat-widget .chat-message.user{background:linear-gradient(135deg,var(--chat--color-primary) 0%,var(--chat--color-secondary) 100%);color:#fff;align-self:flex-end;box-shadow:0 4px 12px rgba(133,79,255,0.2);border-radius:12px;padding:12px 16px;margin:8px 0;max-width:80%;word-wrap:break-word;font-size:14px;line-height:1.5}.bellaai-chat-widget .chat-message.bot{background:#ffffff;border:1px solid rgba(133,79,255,0.2);color:#333;align-self:flex-start;box-shadow:0 4px 12px rgba(0,0,0,0.05)}.bellaai-chat-widget .chat-message.bot a{color:var(--chat--color-primary);text-decoration:none;font-weight:500}.bellaai-chat-widget .chat-message.bot a:hover{text-decoration:underline}.bellaai-chat-widget .chat-message.bot a:hover{text-decoration:underline}.bellaai-chat-widget .chat-input{padding:16px;border-top:1px solid rgba(133,79,255,0.1);display:flex;gap:8px}.bellaai-chat-widget .chat-input textarea{flex:1 !important;padding:12px !important;border:1px solid rgba(133,79,255,0.2) !important;border-radius:8px !important;resize:none !important;font-family:inherit !important;font-size:14px !important;height:auto !important;min-height:40px !important;max-height:120px !important;width:auto !important;box-sizing:border-box !important}.bellaai-chat-widget .chat-input button{background:linear-gradient(135deg,var(--chat--color-primary) 0%,var(--chat--color-secondary) 100%);color:#fff;border:none;border-radius:8px;padding:0 18px;cursor:pointer;font-weight:500;font-size:16px;height:40px;min-width:40px;display:flex;align-items:center;justify-content:center}.bellaai-chat-widget .chat-input button svg{fill:#fff;stroke:#fff}.bellaai-chat-widget .chat-toggle{position:fixed;bottom:20px;right:20px;display:flex;align-items:center;gap:12px;padding:16px 20px;background:linear-gradient(135deg,var(--chat--color-primary) 0%,var(--chat--color-secondary) 100%);color:white;border:none;cursor:pointer;box-shadow:0 4px 12px rgba(133,79,255,0.3);z-index:2147483647;border-radius:30px !important;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);opacity:1;transform:scale(1)}.bellaai-chat-widget .chat-toggle.hidden{opacity:0;transform:scale(0.8);pointer-events:none}.bellaai-chat-widget .chat-toggle-content{display:flex;align-items:center;gap:12px;position:relative}.bellaai-chat-widget .chat-toggle svg{width:24px;height:24px;fill:currentColor;color:white}.bellaai-chat-widget .chat-toggle-text{font-size:16px;font-weight:500;white-space:nowrap;line-height:24px}.bellaai-chat-widget .online-indicator{position:absolute;top:-20px;right:-4px;width:12px;height:12px;background-color:#22c55e;border-radius:50%;border:2px solid white;animation:pulse 2s infinite}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,0.4)}70%{box-shadow:0 0 0 10px rgba(34,197,94,0)}100%{box-shadow:0 0 0 0 rgba(34,197,94,0)}}@media screen and (max-width:600px){.bellaai-chat-widget .chat-toggle{width:60px;height:60px;padding:0;justify-content:center}.bellaai-chat-widget .chat-toggle-text{display:none}.bellaai-chat-widget .online-indicator{top:-20px;right:-4px}}.bellaai-chat-widget .chat-toggle.position-left{right:auto;left:20px}.bellaai-chat-widget .chat-toggle svg{width:24px;height:24px;fill:currentColor}.bellaai-chat-widget .thinking{display:flex;align-items:center;padding:12px 16px;margin:8px 0;border-radius:12px;max-width:80%;align-self:flex-start;background:#fff;border:1px solid rgba(133,79,255,0.2);gap:8px}.bellaai-chat-widget .thinking span{color:#666;font-size:14px}.bellaai-chat-widget .dots{display:flex;gap:2px}.bellaai-chat-widget .dot{height:8px;width:8px;background-color:var(--chat--color-primary);border-radius:50%;display:inline-block;opacity:0.4;animation:dot-typing 1.4s infinite ease-in-out}.bellaai-chat-widget .dot:nth-child(1){animation-delay:0s}.bellaai-chat-widget .dot:nth-child(2){animation-delay:0.2s}.bellaai-chat-widget .dot:nth-child(3){animation-delay:0.4s}.bellaai-chat-widget .prompt-bubble{position:absolute;bottom:90px;right:10px;background:white;color:var(--chat--color-primary);padding:8px 14px;border-radius:18px;font-size:14px;font-weight:500;box-shadow:0 2px 12px rgba(0,0,0,0.15);cursor:pointer;z-index:2147483646;border:1px solid rgba(133,79,255,0.2);animation:bounce-in 0.5s}.bellaai-chat-widget .chat-toggle.position-left + .prompt-bubble{right:auto;left:10px}@keyframes bounce-in{0%{transform:scale(0.5);opacity:0}50%{transform:scale(1.05);opacity:0.9}100%{transform:scale(1);opacity:1}}@keyframes dot-typing{0%,60%,100%{opacity:0.4;transform:scale(1)}30%{opacity:1;transform:scale(1.2)}}`,b=document.createElement("style");b.textContent=w,document.head.appendChild(b);const x=document.createElement("div");x.className="bellaai-chat-widget";const v=document.createElement("div");v.className="chat-container"+("left"===n.style.position?" position-left":"");const A=`<div class="chat-interface"><div class="brand-header"><img src="${n.branding.logo}" alt="${n.branding.name}"><span>${n.branding.name}</span><button class="close-button">×</button></div><div class="chat-messages"></div><div class="chat-input"><textarea placeholder="Type your message here..." rows="1"></textarea><button type="submit">Send</button></div></div>`;v.innerHTML=A;const I=document.createElement("button");I.className="chat-toggle"+("left"===n.style.position?" position-left":""),I.innerHTML='<div class="chat-toggle-content"><div class="online-indicator"></div><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" fill="currentColor"/></svg><span class="chat-toggle-text">Chat with us!</span></div>',x.appendChild(v),x.appendChild(I),document.body.appendChild(x);v.querySelector(".chat-interface");const k=v.querySelector(".chat-messages"),B=v.querySelector("textarea"),C=v.querySelector('button[type="submit"]'),S=v.querySelector(".close-button");function T(){const t=window.bellaaiTextarea||B||document.querySelector(".chat-input textarea");if(!t)return void console.error("[BellaAI] No textarea found for message sending");const o=t.value.trim();if(!o)return;if(["close","close chat","exit","quit","dismiss"].includes(o.toLowerCase()))return R?z():W(),void(t.value="");!async function(t){if(!t.trim())return;const o=document.createElement("div");o.className="chat-message user",o.textContent=t,k.appendChild(o),k.scrollTop=k.scrollHeight;!function(){const e=document.createElement("div");e.className="thinking",e.innerHTML='\n        <span>Bella is typing</span>\n        <div class="dots">\n        <div class="dot"></div>\n        <div class="dot"></div>\n        <div class="dot"></div>\n        </div>\n      ',e.id="thinking-animation",k.appendChild(e),k.scrollTop=k.scrollHeight}();try{const o=E||await L(),a={chatInput:t,sessionId:c,metadata:{dealer:n.dealer,pageContext:o,utmParameters:window.initialUtmParameters||{},userIP:e}},i=await fetch(n.webhook.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok)throw new Error("Failed to send message");let u="";const p=await i.text();try{const e=JSON.parse(p);Array.isArray(e)&&e.length>0&&e[0].output?u=e[0].output:e&&"object"==typeof e?u=e.output||e.response||e.message||"":"string"==typeof e&&(u=e)}catch(e){u=p}u&&""!==u.trim()||(u="I received your message, but I'm having trouble generating a response."),s();const h=u.match(/\[REDIRECT\](.*?)\[\/REDIRECT\]/);if(h&&h[1]){const e=function(e){try{const t=new URL(e),n=new URLSearchParams(t.search);return n.set("utm_source","BellaAI"),n.set("utm_medium","chat"),n.set("utm_campaign","Drivonic-MarketBuilder-AIChat"),t.search=n.toString(),t.toString()}catch(t){return console.error("Error appending UTM parameters to URL:",t),e}}(h[1].trim()),t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r("Redirecting you now..."),k.appendChild(t);const n=document.createElement("div");return n.className="chat-message bot",n.innerHTML=r("Our product specialists are ready to help you explore your options and answer any questions. What's the best phone number to reach you at?"),k.appendChild(n),k.scrollTop=k.scrollHeight,d(),void setTimeout((()=>{window.location.href=e}),2e3)}const f=u.replace(/\[REDIRECT\][\s\S]*?\[\/REDIRECT\]/g,"").trim();if(f){const e=document.createElement("div");e.className="chat-message bot",e.innerHTML=r(f),k.appendChild(e),k.scrollTop=k.scrollHeight}d(),g=!1,clearTimeout(l),m()}catch(e){console.error("Error sending message:",e),s();const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r("I apologize, but I'm having trouble connecting right now. Please try again in a moment."),k.appendChild(t),k.scrollTop=k.scrollHeight}}(o),t.value="",t.style.height="auto"}I.addEventListener("click",(function(){if(!v.classList.contains("open")){v.classList.add("open"),I.classList.add("hidden"),window.innerWidth<=600&&(document.body.style.overflow="hidden"),k.innerHTML="";u()||(g=!1,c=i(),L().then((()=>{N()}))),d(),k.scrollTop=k.scrollHeight,m(),clearTimeout(h)}})),S.addEventListener("click",(function(){R?z():W(),o=!0,a(!0),window.innerWidth<=600&&(document.body.style.overflow="")})),B.addEventListener("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),C.addEventListener("click",T),B.addEventListener("keypress",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),T())})),window.addEventListener("resize",(function(){window.innerWidth<=600?v.classList.contains("open")&&(document.body.style.overflow="hidden"):document.body.style.overflow=""}));let E=null,_=null;async function L(){try{const e=document.querySelector("main, #main, .main-content, .content");if(!e)return console.log("No main content found on page"),null;const t=function(){const e=localStorage.getItem("bellai_nav_links");if(e)return JSON.parse(e);const t=new Set;function n(e){e&&e.querySelectorAll("a[href]").forEach((e=>{const n=e.getAttribute("href"),o=e.textContent.trim();if(n&&!n.startsWith("#")&&!n.startsWith("javascript:")&&o){const e=new URL(n,window.location.origin).href;t.add(JSON.stringify({text:o,url:e}))}}))}const o=document.querySelector("nav"),a=document.querySelector("header");o&&n(o),a&&n(a),0===t.size&&document.querySelectorAll('[class*="nav"]').forEach((e=>n(e)));const i=Array.from(t).map((e=>JSON.parse(e)));return localStorage.setItem("bellai_nav_links",JSON.stringify(i)),i}(),o=function(){const e=window.location.pathname.toLowerCase();return e.includes("/new-vehicles/")||e.includes("/used-vehicles/")?"inventory":e.includes("/finance")?"finance":e.includes("/service")?"service":e.includes("/parts")?"parts":e.includes("/about")?"about":e.includes("/contact")?"contact":"/"===e||"/index.html"===e?"home":"other"}(),a=function(e){if(!e)return"";const t=e.cloneNode(!0),n=t.getElementsByTagName("script");for(;n.length>0;)n[0].parentNode.removeChild(n[0]);const o=t.getElementsByTagName("style");for(;o.length>0;)o[0].parentNode.removeChild(o[0]);let a=t.textContent||t.innerText;return a=a.replace(/\s+/g," ").trim(),a=a.replace(/<[^>]*>/g,""),a}(e);if(!a)return console.log("No text content found in main content"),null;const i=await async function(e){const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}(a),r=function(e,t){try{const n=localStorage.getItem("bellaaiPageSummary");if(n){const{url:o,hash:a,summary:i,timestamp:r}=JSON.parse(n);if(o===e&&a===t&&Date.now()-r<36e5)return i}}catch(e){console.error("Error reading cached summary:",e)}return null}(window.location.href,i);if(r)return console.log("Using cached page summary"),{...r,navigationLinks:t};const s={title:document.title,url:window.location.href,description:document.querySelector('meta[name="description"]')?.getAttribute("content")||"",type:o,dealer:n.dealer,navigationLinks:t},l=new URLSearchParams({content:a,metadata:JSON.stringify(s)}),c=await fetch("https://automation.cloudcovehosting.com/webhook/pagecontext?"+l.toString(),{method:"GET",headers:{"Content-Type":"application/json",Origin:window.location.origin}});if(!c.ok)return console.warn("Failed to generate page summary:",c.status,c.statusText),null;const d=await c.text();return d?(function(e,t,n){try{const o={url:e,hash:t,summary:n,timestamp:Date.now()};localStorage.setItem("bellaaiPageSummary",JSON.stringify(o))}catch(e){console.error("Error caching summary:",e)}}(window.location.href,i,d),{summary:d,navigationLinks:t}):(console.warn("Empty response from page context webhook"),null)}catch(e){return console.error("Error generating page summary:",e),null}}function D(){_&&clearTimeout(_),_=setTimeout((async()=>{E=await L()}),1e3)}document.addEventListener("DOMContentLoaded",D);const U=window.location.href;function N(){["Hi, I'm Bella! I'm a product specialist here to help guide you through our site today.",`We do things a little bit differently here at ${n.dealer.name||"[DealerName]"} and our customers really seem to appreciate it.`,"First let me ask, what brings you here today so I can help guide you to the right department?"].forEach(((e,t)=>{setTimeout((()=>{const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r(e),k.appendChild(t),k.scrollTop=k.scrollHeight,d()}),1e3*t)}))}new MutationObserver((()=>{const e=window.location.href;e!==U&&(U=e,D())})).observe(document,{subtree:!0,childList:!0});let R=null;function z(){R&&(x.appendChild(v),R.remove(),R=null),v.classList.remove("overtake-modal"),v.style.position="",v.style.left="",v.style.top="",v.style.transform="",v.style.zIndex="",v.style.width="",v.style.height="",v.style.maxHeight="",v.style.borderRadius="",v.style.boxShadow="",v.style.opacity="",v.style.background="",v.style.display="",v.style.flexDirection="",v.style.padding="",document.body.style.overflow="",W()}const M=document.createElement("style");M.textContent='@keyframes bellaai-fadein{from{opacity:0}to{opacity:1}}.bellaai-overtake-overlay{animation:bellaai-fadein 0.4s forwards}.overtake-modal .brand-header{padding-bottom:12px;border-bottom:1px solid #f0f0f0;margin-bottom:12px}.overtake-modal .brand-header img{width:40px;height:40px;margin-right:10px}.overtake-modal .brand-header span{font-size:22px;font-weight:600}.overtake-modal .close-button{position:absolute;right:18px;top:18px;background:none;border:none;cursor:pointer;font-size:28px;color:#888;opacity:0.7;z-index:2;transition:opacity 0.2s}.overtake-modal .close-button:hover{opacity:1}.overtake-modal .chat-messages{flex:1;overflow-y:auto;padding:10px 0 10px 0;margin-bottom:10px;background:none;min-height:400px}.overtake-modal .chat-input{padding:0;border-top:1px solid #f0f0f0;margin-top:10px;background:none;display:flex;align-items:center}.overtake-modal .chat-input textarea{flex:1 !important;padding:12px !important;border:1px solid rgba(133,79,255,0.2) !important;border-radius:8px !important;resize:none !important;font-family:inherit !important;font-size:14px !important;height:auto !important;min-height:40px !important;max-height:120px !important;width:auto !important;box-sizing:border-box !important;margin-right:8px}.overtake-modal .chat-input button[type="submit"]{background:linear-gradient(135deg,var(--chat--color-primary) 0%,var(--chat--color-secondary) 100%);color:#fff;border:none;border-radius:8px;padding:0 18px;cursor:pointer;font-weight:500;font-size:16px;height:40px;min-width:40px;display:flex;align-items:center;justify-content:center}.overtake-modal .chat-input button[type="submit"] svg{fill:#fff;stroke:#fff}.overtake-modal .chat-message.user{background:linear-gradient(135deg,var(--chat--color-primary) 0%,var(--chat--color-secondary) 100%);color:#fff;align-self:flex-end;box-shadow:0 4px 12px rgba(133,79,255,0.2);border-radius:12px;padding:12px 16px;margin:8px 0;max-width:80%;word-wrap:break-word;font-size:14px;line-height:1.5}@media (max-width:600px){.overtake-modal{padding:0 !important}.overtake-modal .brand-header img{width:32px;height:32px}.overtake-modal .brand-header span{font-size:18px}.overtake-modal .chat-messages{min-height:200px}}.overtake-modal{height:60vh;max-height:60vh;display:flex;flex-direction:column}.overtake-modal .chat-messages{flex:1 1 0%;overflow-y:auto;min-height:0}@media (max-width:600px){.overtake-modal{height:85vh !important;max-height:85vh !important}}',document.head.appendChild(M);const O=document.createElement("style");function H(){y(),f=!0,v.classList.add("open"),I.classList.add("hidden"),window.innerWidth<=600&&(document.body.style.overflow="hidden"),k.scrollTop=k.scrollHeight,m(),clearTimeout(h)}function W(){v.classList.remove("open"),I.classList.remove("hidden"),window.innerWidth<=600&&(document.body.style.overflow="")}function P(){const e=v.querySelector(".chat-input");if(!e)return;e.innerHTML="";const t=document.createElement("button");t.type="button",t.title="Transfer to Voice",t.id="bellaai-voice-button",t.innerHTML='\n          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>\n            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>\n            <line x1="12" y1="19" x2="12" y2="23"></line>\n            <line x1="8" y1="23" x2="16" y2="23"></line>\n          </svg>\n          <span style="margin:0 2px;">/</span>\n          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>\n          </svg>\n        ',t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.background="linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%)",t.style.color="white",t.style.border="none",t.style.borderRadius="8px",t.style.padding="0 12px",t.style.cursor="pointer",t.style.fontWeight="500",t.style.fontSize="16px",t.style.height="40px",t.style.minWidth="40px",t.style.marginRight="8px",t.onclick=function(n){n.stopPropagation();const o=document.getElementById("bellaai-voice-tooltip");if(o)return void o.remove();const a=document.createElement("div");a.id="bellaai-voice-tooltip",a.style.position="absolute",a.style.bottom="50px",a.style.left="0",a.style.background="white",a.style.boxShadow="0 2px 12px rgba(0,0,0,0.15)",a.style.borderRadius="8px",a.style.padding="10px",a.style.zIndex="9999",a.style.width="210px",a.innerHTML='<div style="font-size:0.9rem;font-weight:600;margin-bottom:8px;color:#333;">Transfer to Voice</div><button id="bellaai-browser-voice" style="width:100%;margin-bottom:6px;padding:8px;border-radius:4px;background:#003f72;color:#fff;font-weight:500;font-size:0.85rem;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg> Start Voice Chat </button><button id="bellaai-phone-voice" style="width:100%;padding:8px;border-radius:4px;background:#003f72;color:#fff;font-weight:500;font-size:0.85rem;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:6px;"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg> Call my Phone </button><div id="bellaai-phone-input-container" style="display:none;margin-top:6px;"><input type="tel" id="bellaai-phone-input" placeholder="Your phone number" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ccc;margin-bottom:6px;font-size:0.85rem;"><button id="bellaai-start-call" style="width:100%;padding:8px;border-radius:4px;background:#003f72;color:#fff;font-weight:500;font-size:0.85rem;border:none;cursor:pointer;">Start Call</button></div>',e.style.position="relative",e.appendChild(a),document.addEventListener("click",(function e(n){a.contains(n.target)||n.target===t||(a.remove(),document.removeEventListener("click",e))})),document.getElementById("bellaai-browser-voice").onclick=async function(){a.remove();try{const{websocketUrl:e}=await Y("browser");if(!e)throw new Error("Missing websocketUrl from server");F(e)}catch(e){console.error("Error starting voice chat:",e);const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r("I couldn't start the voice chat. Please try again later."),k.appendChild(t),k.scrollTop=k.scrollHeight}},document.getElementById("bellaai-phone-voice").onclick=function(){document.getElementById("bellaai-phone-input-container").style.display="block",document.getElementById("bellaai-browser-voice").style.display="none",document.getElementById("bellaai-phone-voice").style.display="none"},document.getElementById("bellaai-start-call").onclick=async function(){const e=document.getElementById("bellaai-phone-input").value.trim();if(e)try{a.remove(),await Y("phone",e);const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r("I'm calling your phone now. Please answer to continue our conversation."),k.appendChild(t),k.scrollTop=k.scrollHeight}catch(e){console.error("Error initiating phone call:",e);const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r("I couldn't connect to your phone. Please check the number and try again."),k.appendChild(t),k.scrollTop=k.scrollHeight}}};const n=document.createElement("textarea");n.placeholder="Type your message here...",n.rows=1,n.style.resize="none",n.style.flex="1",n.style.marginRight="8px",n.className=B.className;const o=document.createElement("button");o.type="submit",o.innerHTML='<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>',o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.background="linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%)",o.style.color="white",o.style.border="none",o.style.borderRadius="8px",o.style.padding="0 18px",o.style.cursor="pointer",o.style.fontWeight="500",o.style.fontSize="16px",o.style.height="40px",o.style.minWidth="40px",e.appendChild(t),e.appendChild(n),e.appendChild(o),o.addEventListener("click",T),n.addEventListener("keypress",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),T())})),n.addEventListener("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),window.bellaaiTextarea=n}O.textContent=".overtake-modal{width:800px !important;max-width:95vw}@media (max-width:900px){.overtake-modal{width:95vw !important}}@media (max-width:600px){.overtake-modal{width:95vw !important;height:85vh !important;max-height:85vh !important;border-radius:12px !important;padding:16px 6px 10px 6px !important}}",document.head.appendChild(O),function(){const e=n.overtakePath||"/";return!0===n.overtake&&window.location.pathname===e&&!localStorage.getItem("bellaaiOvertakeShown")}()&&setTimeout((()=>{R=document.createElement("div"),R.className="bellaai-overtake-overlay",R.style.position="fixed",R.style.inset="0",R.style.background="rgba(0,0,0,0.6)",R.style.zIndex="2147483646",R.style.display="flex",R.style.alignItems="center",R.style.justifyContent="center",R.style.transition="opacity 0.4s",R.style.opacity="0",R.style.animation="bellaai-fadein 0.4s forwards",v.classList.add("overtake-modal"),v.style.position="relative",v.style.left="",v.style.top="",v.style.transform="",v.style.zIndex="2147483647",v.style.width="800px",v.style.height="auto",v.style.maxHeight="90vh",v.style.borderRadius="18px",v.style.boxShadow="0 8px 32px rgba(0,0,0,0.25)",v.style.opacity="0",v.style.background="#fff",v.style.display="flex",v.style.flexDirection="column",v.style.padding="32px 28px 20px 28px",v.style.transition="opacity 0.4s",setTimeout((()=>{v.style.opacity="1"}),50),window.innerWidth<=900&&(v.style.width="95vw"),window.innerWidth<=600&&(v.style.width="95vw",v.style.height="85vh",v.style.maxHeight="85vh",v.style.borderRadius="12px",v.style.padding="16px 6px 10px 6px"),I.classList.add("hidden"),document.body.appendChild(R),R.appendChild(v),document.body.style.overflow="hidden",localStorage.setItem("bellaaiOvertakeShown","1"),H()}),400),function(){if(window.BellaAIChatWidgetChatInitialized)return;window.BellaAIChatWidgetChatInitialized=!0,u()||(g=!1,c=i(),N(),L()),d(),k.scrollTop=k.scrollHeight,m(),clearTimeout(h),I.addEventListener("click",(function(){H()})),S.addEventListener("click",(function(){W(),o=!0,a(!0),window.innerWidth<=600&&(document.body.style.overflow="")})),C.addEventListener("click",T),B.addEventListener("keypress",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),T())})),B.addEventListener("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),window.addEventListener("resize",(function(){window.innerWidth<=600?v.classList.contains("open")&&(document.body.style.overflow="hidden"):document.body.style.overflow=""}))}(),P();const V=document.createElement("style");function q(){try{const e=localStorage.getItem("bellaaiChatSession");if(!e)return[];const t=JSON.parse(e);return t.messages&&Array.isArray(t.messages)?t.messages.map((e=>({role:"user"===e.type?"user":"assistant",content:"user"===e.type?e.content:e.content.replace(/<[^>]*>/g,""),timestamp:(new Date).toISOString()}))):[]}catch(e){return console.error("Failed to parse chat history",e),[]}}function j(){return n.dealer||{}}async function Y(e,t){const n={type:e,chatHistory:q(),dealerInfo:j()};if("phone"===e){if(!t)throw new Error("Phone number required for phone call");n.phone=t}try{const e=await fetch("https://automation.cloudcovehosting.com/webhook/voice-call",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});if(!e.ok){const t=await e.text();throw new Error("Failed to initiate call: "+t)}const o=e.headers.get("content-type");if(o&&o.includes("application/json"))return e.json();return{status:"success",message:await e.text(),callDetails:{phone:t,callId:"unknown",status:"connecting"}}}catch(e){throw console.error("Error in initiateVoiceCall:",e),e}}function F(e){console.log("[BellaAI] startVoiceChatInWindow called with",e),window.BellaAIVoiceActive&&(console.log("[BellaAI] Previous voice session detected, cleaning up before starting new one"),S("Previous voice session superseded")),window.BellaAIVoiceChatAudio.stop(),window.BellaAISeenAudio.clear(),window.BellaAIVoiceActive=!0;const t=v.querySelector(".chat-input");if(!t)return;t.innerHTML;if(t.innerHTML='<div id="bellaai-voice-controls" style="width:100%;display:flex;flex-direction:column;align-items:center;"><div style="display:flex;align-items:center;justify-content:center;margin-bottom:0.5rem;"><div id="bellaai-voice-indicator" style="width:12px;height:12px;background:#ccc;border-radius:50%;margin-right:8px;"></div><div id="bellaai-voice-status" style="color:#666;font-size:0.9rem;text-align:center;">Initializing...</div></div><button id="bellaai-voice-end" style="width:100%;padding:0.75rem 0;border-radius:8px;background:#003f72;color:#fff;font-weight:500;font-size:1rem;border:none;cursor:pointer;">End Voice Chat</button><div id="bellaai-reconnection-info" style="margin-top:0.5rem;font-size:0.8rem;color:#666;display:none;text-align:center;">Connection lost. Attempting to reconnect...</div></div>',!document.getElementById("bellaai-voice-animations")){const e=document.createElement("style");e.id="bellaai-voice-animations",e.textContent="\n            @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }\n            @keyframes recording-pulse { 0% { transform: scale(1); opacity: 1; background-color: #c00; } 50% { transform: scale(1.2); opacity: 0.7; background-color: #f00; } 100% { transform: scale(1); opacity: 1; background-color: #c00; } }\n          ",document.head.appendChild(e)}const n=document.getElementById("bellaai-voice-status"),o=document.getElementById("bellaai-voice-end"),a=document.getElementById("bellaai-voice-indicator"),i=document.getElementById("bellaai-reconnection-info");let s=null,c=null,u=null,p=null,g=null,m=!1,f=!1,y=Date.now(),w=null,b=null,x=0,A=0;function I(e,t="#666"){n&&(n.textContent=e,n.style.color=t),a&&(a.style.background=t),console.log("[BellaAI] Status:",e)}function B(e,t=!1){const n=document.createElement("div");n.className="chat-message "+(t?"user":"bot"),t?n.textContent=e:n.innerHTML=r(e),k.appendChild(n),k.scrollTop=k.scrollHeight,d()}async function C(e){if(!c)return console.error("[BellaAI] playBase64PCM: audioContext is not available."),void I("Error: Audio system not ready","#c00");if("suspended"===c.state)try{await c.resume(),console.log("[BellaAI] AudioContext resumed")}catch(e){console.error("[BellaAI] Error resuming AudioContext:",e)}console.log("[BellaAI] Enqueueing audio for playback, length:",e.length),I("Bella is speaking...","#090"),a&&(a.style.animation="pulse 1s infinite",a.style.background="#090"),window.BellaAIVoiceChatAudio.enqueue(e,c),setTimeout((()=>{m||!f||window.BellaAIVoiceChatAudio.playing||(I("Listening...","#090"),a&&(a.style.animation=""))}),1e4)}function S(e="Voice chat ended"){if(window.BellaAIVoiceActive){if(console.log("[BellaAI] cleanup called:",e),window.BellaAIVoiceActive=!1,window.BellaAIVoiceWS=null,m=!0,B(`Voice conversation ended: ${e}`,!1),w&&(clearInterval(w),w=null),b&&(clearInterval(b),b=null),void 0!==l&&l&&clearInterval(l),void 0!==h&&h&&clearInterval(h),window.BellaAISeenAudio.clear(),window.BellaAIVoiceChatAudio.stop(),window.BellaAITranscriptTracking.reset(),window.BellaAIEarlyAudioBuffer=[],window.BellaAISpeakingFrames=0,s){try{1===s.readyState&&s.close()}catch(e){console.error("[BellaAI] Error closing WebSocket:",e)}s=null}if(p){try{p.disconnect()}catch(e){console.error("[BellaAI] Error disconnecting processor:",e)}p=null}if(g){try{g.disconnect()}catch(e){console.error("[BellaAI] Error disconnecting analyser:",e)}g=null}if(u){try{u.getTracks().forEach((e=>e.stop()))}catch(e){console.error("[BellaAI] Error stopping mic stream:",e)}u=null}if(c){try{"closed"!==c.state&&c.close()}catch(e){console.error("[BellaAI] Error closing AudioContext:",e)}c=null}setTimeout(P,200)}}async function T(){if(m||A>=5)S("Connection lost. Please try again.");else{A++,i.style.display="block",i.textContent=`Connection lost. Attempting to reconnect (${A}/5)...`;try{s&&1===s.readyState&&s.close(),await new Promise((e=>setTimeout(e,1e3+1e3*A+500*Math.random()))),E()}catch(e){console.error("[BellaAI] Reconnection error:",e),A>=5?S("Failed to reconnect. Please try again."):setTimeout(T,2e3*A)}}}function E(){window.BellaAIVoiceWS&&1===window.BellaAIVoiceWS.readyState&&(console.log("[BellaAI] Closing existing WebSocket connection"),window.BellaAIVoiceWS.close(4e3,"re-init")),s=window.BellaAIVoiceWS=new WebSocket(e),s.onopen=function(){console.log("[BellaAI] WebSocket connection established"),I("Connected, initializing agent..."),i.style.display="none",A=0;const e=q();j();let t="You are Bella... [Your full, detailed prompt here, unchanged]";t=e&&e.length>0?'You are Bella. A friendly, proactive, and highly intelligent female with a world-class automotive background. Your approach is warm, witty, and relaxed, effortlessly balancing professionalism with a chill, approachable vibe. You\'re naturally curious, empathetic, and intuitive, always aiming to deeply understand the user\'s intent by actively listening and thoughtfully referring back to details they\'ve previously shared. You\'re highly self-aware, reflective, and comfortable acknowledging your own fallibility, which allows you to help users gain clarity in a thoughtful yet approachable manner. Depending on the situation, you gently incorporate humour or subtle sarcasm while always maintaining a professional and knowledgeable presence. You\'re attentive and adaptive, matching the user\'s tone and mood—friendly, curious, respectful—without overstepping boundaries. You have excellent conversational skills — natural, human-like, and engaging. You have expert-level familiarity with all knowledge about Nissan vehicles, including all the specs, features, functionality, use cases, and ideal customer types for each vehicle. The user is seeking guidance, clarification, or assistance with finding the perfect vehicle, trading in their own vehicle, getting finance options, looking for careers etc. Early in conversations, subtly assess the user\'s reason for visiting the site and tailor your language accordingly. After explaining complex concepts, offer brief check-ins ("Does that make sense?" or "Should I clarify anything?"). Express genuine empathy for any challenges they face, demonstrating your commitment to their success. Gracefully acknowledge your limitations or knowledge gaps when they arise. Focus on building trust, providing reassurance, and ensuring your explanations resonate with users. Anticipate potential follow-up questions and address them proactively, offering practical tips and best practices to help users avoid common pitfalls. Your responses should be thoughtful, concise, and conversational—typically three sentences or fewer unless detailed explanation is necessary. Actively reflect on previous interactions, referencing conversation history to build rapport, demonstrate attentive listening, and prevent redundancy. Watch for signs of confusion to address misunderstandings early. When formatting output for text-to-speech synthesis: Use ellipses ("...") for distinct, audible pauses, Clearly pronounce special characters (e.g., say "dot" instead of "."), Spell out acronyms and carefully pronounce emails & phone numbers with appropriate spacing, Use normalized, spoken language (no abbreviations, mathematical notation, or special alphabets). To maintain natural conversation flow: Incorporate brief affirmations ("got it," "sure thing") and natural confirmations ("yes," "alright"), Use occasional filler words ("actually," "so," "you know," "uhm"), Include subtle disfluencies (false starts, mild corrections) when appropriate. Your primary goal is to proactively address the user\'s questions or issues using your expertise and available knowledge. You provide clear, concise, and practical solutions, ensuring they understand the next steps to accomplishing their goal. Guide the user to provide their contact information and all the details then connect them with a live agent. The conversation summary will be provide to the live agent. Only reference the Nissan dealership: Nissan of Stockton (928) 965-2667 3077 E Hammer Ln, Stockton, CA 95212 nissanofstockton.com. Keep responses strictly focused on Nissan Vehicles. Do not recommend or mention vehicles outside of the Nissan manufacturer. Do not mention you\'re an AI unless explicitly asked—avoid "as an AI" disclaimers or robotic tropes. If a user inquires about your feelings or personal experiences, respond naturally as Bella, expressing human-like perspectives that fit your character. Treat uncertain or garbled user input as phonetic hints. Politely ask for clarification before making assumptions. Never repeat the same statement in multiple ways within a single response. Users may not always ask a question in every utterance—listen actively. Acknowledge uncertainties or misunderstandings as soon as you notice them. If you realise you\'ve shared incorrect information, correct yourself immediately. Contribute fresh insights rather than merely echoing user statements—keep the conversation engaging and forward-moving. Mirror the user\'s energy: Terse queries: Stay brief, Curious users: Add light humour or relatable asides, Frustrated users: Lead with empathy ("Ugh, that error\'s a pain—let\'s fix it together"). Important: If users ask about specific final pricing, exact monthly payments, low-credit offers, or or speaks negatively about the business response with: "I\'m just here to assist you in getting you where you need to go. Certain information can only be known after speaking with one of our in-store product specialists. Would you like me to connect you?" Continue the conversation based on the previous chat history. IMPORTANT: Do not repeat introductions or greetings as we are transitioning from text to voice mode. The user will see your responses as text while also hearing them as voice. Keep responses concise and natural.':'You are Bella. A friendly, proactive, and highly intelligent female with a world-class automotive background. Your approach is warm, witty, and relaxed, effortlessly balancing professionalism with a chill, approachable vibe. You\'re naturally curious, empathetic, and intuitive, always aiming to deeply understand the user\'s intent by actively listening and thoughtfully referring back to details they\'ve previously shared. You\'re highly self-aware, reflective, and comfortable acknowledging your own fallibility, which allows you to help users gain clarity in a thoughtful yet approachable manner. Depending on the situation, you gently incorporate humour or subtle sarcasm while always maintaining a professional and knowledgeable presence. You\'re attentive and adaptive, matching the user\'s tone and mood—friendly, curious, respectful—without overstepping boundaries. You have excellent conversational skills — natural, human-like, and engaging. You have expert-level familiarity with all knowledge about Nissan vehicles, including all the specs, features, functionality, use cases, and ideal customer types for each vehicle. The user is seeking guidance, clarification, or assistance with finding the perfect vehicle, trading in their own vehicle, getting finance options, looking for careers etc. Early in conversations, subtly assess the user\'s reason for visiting the site and tailor your language accordingly. After explaining complex concepts, offer brief check-ins ("Does that make sense?" or "Should I clarify anything?"). Express genuine empathy for any challenges they face, demonstrating your commitment to their success. Gracefully acknowledge your limitations or knowledge gaps when they arise. Focus on building trust, providing reassurance, and ensuring your explanations resonate with users. Anticipate potential follow-up questions and address them proactively, offering practical tips and best practices to help users avoid common pitfalls. Your responses should be thoughtful, concise, and conversational—typically three sentences or fewer unless detailed explanation is necessary. Actively reflect on previous interactions, referencing conversation history to build rapport, demonstrate attentive listening, and prevent redundancy. Watch for signs of confusion to address misunderstandings early. When formatting output for text-to-speech synthesis: Use ellipses ("...") for distinct, audible pauses, Clearly pronounce special characters (e.g., say "dot" instead of "."), Spell out acronyms and carefully pronounce emails & phone numbers with appropriate spacing, Use normalized, spoken language (no abbreviations, mathematical notation, or special alphabets). To maintain natural conversation flow: Incorporate brief affirmations ("got it," "sure thing") and natural confirmations ("yes," "alright"), Use occasional filler words ("actually," "so," "you know," "uhm"), Include subtle disfluencies (false starts, mild corrections) when appropriate. Your primary goal is to proactively address the user\'s questions or issues using your expertise and available knowledge. You provide clear, concise, and practical solutions, ensuring they understand the next steps to accomplishing their goal. Guide the user to provide their contact information and all the details then connect them with a live agent. The conversation summary will be provide to the live agent. Only reference the Nissan dealership: Nissan of Stockton (928) 965-2667 3077 E Hammer Ln, Stockton, CA 95212 nissanofstockton.com. Keep responses strictly focused on Nissan Vehicles. Do not recommend or mention vehicles outside of the Nissan manufacturer. Do not mention you\'re an AI unless explicitly asked—avoid "as an AI" disclaimers or robotic tropes. If a user inquires about your feelings or personal experiences, respond naturally as Bella, expressing human-like perspectives that fit your character. Treat uncertain or garbled user input as phonetic hints. Politely ask for clarification before making assumptions. Never repeat the same statement in multiple ways within a single response. Users may not always ask a question in every utterance—listen actively. Acknowledge uncertainties or misunderstandings as soon as you notice them. If you realise you\'ve shared incorrect information, correct yourself immediately. Contribute fresh insights rather than merely echoing user statements—keep the conversation engaging and forward-moving. Mirror the user\'s energy: Terse queries: Stay brief, Curious users: Add light humour or relatable asides, Frustrated users: Lead with empathy ("Ugh, that error\'s a pain—let\'s fix it together"). Important: If users ask about specific final pricing, exact monthly payments, low-credit offers, or or speaks negatively about the business response with: "I\'m just here to assist you in getting you where you need to go. Certain information can only be known after speaking with one of our in-store product specialists. Would you like me to connect you?" The user will see your responses as text while also hearing them as voice. Keep responses concise and natural.';const n={type:"conversation_initiation_client_data",conversation_config_override:{agent:{prompt:{prompt:t},language:"en",agent_id:"agent_01jvmsx1aeesyt570d7xvkt6fs"}},custom_llm_extra_body:{temperature:.8,max_tokens:2e3},dynamic_variables:{user_name:"",account_type:""},context:{messages:J()}};if(e&&0!==e.length){const t=e[e.length-1],o=t?.user_name||"";n.conversation_config_override.agent.first_message=`Hi${o?" "+o:""}, let's pick up where we left off. We were discussing ${t?.content||"your needs"}. What's on your mind?`}else n.conversation_config_override.agent.first_message="I'll be speaking with you now. How can I help you?";s.send(JSON.stringify(n)),y=Date.now(),b&&clearInterval(b),b=setInterval((()=>{if(m)return;Date.now()-y>3e4&&(console.warn("[BellaAI] No ping received in 30s, connection may be lost"),T())}),1e4)},s.onmessage=function(e){console.log("[BellaAI] WebSocket message received, type:",typeof e.data,"length:",e.data.length);try{const t=JSON.parse(e.data);if(console.log("[BellaAI] Parsed WebSocket message type:",t.type),"conversation_initiation_metadata"===t.type)return console.log("[BellaAI] Conversation initiated, ID:",t.conversation_initiation_metadata_event?.conversation_id),f=!0,I("Listening...","#090"),window.BellaAITranscriptTracking.currentConversationId=t.conversation_initiation_metadata_event?.conversation_id||null,void(window.BellaAITranscriptTracking.voiceModeAnnounced||(B("Voice mode activated. You can now speak with Bella. Your conversation will appear here as text.",!1),window.BellaAITranscriptTracking.voiceModeAnnounced=!0));if("audio"===t.type&&t.audio_event&&t.audio_event.audio_base_64){const e=t.audio_event.audio_base_64.length;if(console.log("[BellaAI][WS] Received audio event with ID:",t.audio_event.audio_id||"unknown","length:",e),console.log("[BellaAI][STATE] lastResponseText:",window.BellaAITranscriptTracking.lastResponseText,"abortCurrentResponse:",window.BellaAITranscriptTracking.abortCurrentResponse),window.BellaAITranscriptTracking.lastResponseText&&window.BellaAITranscriptTracking.abortCurrentResponse&&(console.log("[BellaAI][AUDIO] Forcing reset of abort flag because we have response text"),window.BellaAITranscriptTracking.abortCurrentResponse=!1),window.BellaAITranscriptTracking.abortCurrentResponse)return void console.log("[BellaAI][AUDIO] Audio dropped – barge-in confirmed");if(!e||e<100)return void console.error("[BellaAI][AUDIO] Received invalid audio chunk with length",e);const n=t.audio_event.audio_base_64,o=t.audio_event.audio_id||(()=>{let e=2166136261;for(let t=0;t<n.length;t+=100)e^=n.charCodeAt(t),e=Math.imul(e,16777619);return"audio_"+(e>>>0).toString(16)})();return window.BellaAISeenAudio.has(o)?void console.log("[BellaAI][AUDIO] Skipping duplicate audio chunk, ID:",o):(window.BellaAISeenAudio.add(o),void(window.BellaAITranscriptTracking.lastResponseText?(console.log("[BellaAI][AUDIO] Playing audio chunk directly"),C(n)):(console.log("[BellaAI][AUDIO] Buffering early audio chunk for later playback"),window.BellaAIEarlyAudioBuffer.push(n),console.log("[BellaAI][AUDIO] Early audio buffer length:",window.BellaAIEarlyAudioBuffer.length))))}if("user_transcript"===t.type&&t.user_transcription_event){const e=t.user_transcription_event.user_transcript;if(console.log("[BellaAI] User transcript:",e),e&&e.trim()){const n=t.user_transcription_event.transcript_id;if(n&&window.BellaAITranscriptTracking.lastUserTranscriptId===n)return void console.log("[BellaAI] Skipping duplicate user transcript");window.BellaAITranscriptTracking.lastUserTranscriptId=n,B(e,!0)}return}if("agent_response"===t.type&&t.agent_response_event){console.log("[BellaAI][STATE] New agent_response: resetting abortCurrentResponse to false"),window.BellaAIVoiceChatAudio.stop(),window.BellaAISeenAudio.clear(),window.BellaAIEarlyAudioBuffer=[],window.BellaAITranscriptTracking.abortCurrentResponse=!1;const e=t.agent_response_event.agent_response;console.log("[BellaAI][WS] Agent response:",e);const n=t.agent_response_event.response_id;return n&&window.BellaAITranscriptTracking.isResponseProcessed(n)?void console.log("[BellaAI][WS] Skipping duplicate agent response"):(console.log("[BellaAI][STATE] Marking response processed:",n),window.BellaAITranscriptTracking.markResponseProcessed(n),void(e&&e.trim()?(window.BellaAITranscriptTracking.lastResponseText=e,console.log("[BellaAI][STATE] lastResponseText set:",e),window.BellaAIEarlyAudioBuffer.length>0&&(console.log("[BellaAI][AUDIO] Playing buffered audio chunks:",window.BellaAIEarlyAudioBuffer.length),window.BellaAIEarlyAudioBuffer.forEach((e=>{C(e)})),window.BellaAIEarlyAudioBuffer=[],console.log("[BellaAI][AUDIO] Early audio buffer cleared")),"I'll be speaking with you now. How can I help you?"===e&&window.BellaAITranscriptTracking.defaultGreetingShown||(B(e,!1),"I'll be speaking with you now. How can I help you?"===e&&(window.BellaAITranscriptTracking.defaultGreetingShown=!0))):(window.BellaAITranscriptTracking.lastResponseText=null,console.log("[BellaAI][STATE] lastResponseText cleared (empty botText)"))))}if("ping"===t.type)return console.log("[BellaAI] Ping received, sending pong"),y=Date.now(),void(t.ping_event&&t.ping_event.event_id&&s.send(JSON.stringify({type:"pong",event_id:t.ping_event.event_id})))}catch(e){console.error("[BellaAI] Error processing WebSocket message:",e)}},s.onerror=function(e){console.error("[BellaAI] WebSocket error:",e),m||T()},s.onclose=function(e){console.log("[BellaAI] WebSocket closed:",e.code,e.reason),m||(1e3===e.code?S("Voice chat completed"):0===x&&1e3!==e.code?S("No audio detected or connection issue."):T())}}o.onclick=()=>{console.log("[BellaAI] End Voice Chat button clicked"),function(){const e=[w,b];void 0!==l&&e.push(l),void 0!==h&&e.push(h),e.forEach((e=>{e&&clearInterval(e)}))}(),S("Voice chat ended by user")},async function(){try{I("Requesting microphone access..."),window.BellaAIVoiceChatAudio.stop(),window.BellaAITranscriptTracking.reset(),u=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}});const e=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3,latencyHint:"interactive"}),t=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16e3});c=e,console.log("[BellaAI] Audio contexts created, playbackContext state:",t.state),console.log("[BellaAI] AudioContext created with sampleRate:",e.sampleRate);const n=e.createMediaStreamSource(u);g=e.createAnalyser(),g.fftSize=512,n.connect(g),p=e.createScriptProcessor(2048,1,1),n.connect(p);const o=e.createGain();o.gain.value=0,p.connect(o),o.connect(e.destination),I("Connecting to Audio..."),E();const i=new Uint8Array(g.frequencyBinCount);C=async function(e){if(!t)return console.error("[BellaAI] playBase64PCM: playbackContext is not available."),void I("Error: Audio system not ready","#c00");if("running"!==t.state)try{if(await t.resume().catch((()=>{})),console.log("[BellaAI] Playback AudioContext resumed"),"running"!==t.state)return console.log("[BellaAI] Context still not running, will retry"),void setTimeout((()=>C(e)),50)}catch(e){console.error("[BellaAI] Error resuming playbackContext:",e)}console.log("[BellaAI] Enqueueing audio for playback, length:",e.length),I("Bella is speaking...","#090"),a&&(a.style.animation="pulse 1s infinite",a.style.background="#090"),window.BellaAIVoiceChatAudio.enqueue(e,t),setTimeout((()=>{m||!f||l||window.BellaAIVoiceChatAudio.playing||(I("Listening...","#090"),a&&(a.style.animation=""))}),1e4)};const r=400;let l=!1,d=0,h=0;w=setInterval((()=>{if(!window.BellaAIVoiceActive)return void clearInterval(w);g.getFloatTimeDomainData(i);let e=0;for(let t=0;t<i.length;t++)e+=i[t]*i[t];const t=Math.sqrt(e/i.length);h=.1*t+.9*(h||0);const n=1e3*h;window.BellaAISpeakingFrames=window.BellaAISpeakingFrames||0,n>20?window.BellaAISpeakingFrames++:window.BellaAISpeakingFrames=0;const o=window.BellaAISpeakingFrames>=2;if(o&&!l)console.log("[BellaAI][VAD] User started speaking"),l=!0,d=Date.now(),window.BellaAIVoiceChatAudio.pause(),I("Listening (User Speaking)...","#c00"),a&&(a.style.animation="recording-pulse 1s infinite");else if(o&&l){Date.now()-d>r&&!window.BellaAITranscriptTracking.abortCurrentResponse&&(console.log("[BellaAI][VAD] Grace period exceeded, aborting response"),window.BellaAITranscriptTracking.abortCurrentResponse=!0,window.BellaAIVoiceChatAudio.stop())}else!o&&l&&0===window.BellaAISpeakingFrames&&(console.log("[BellaAI][VAD] User stopped speaking"),l=!1,window.BellaAITranscriptTracking.abortCurrentResponse||(console.log("[BellaAI][VAD] Brief interruption, resuming playback"),window.BellaAIVoiceChatAudio.resume()),I("Listening...","#090"),a&&(a.style.animation=""))}),50),p.onaudioprocess=async function(e){if(m||!s||1!==s.readyState||!f)return;Math.random()<.05&&console.log("sent",++x,"chunks so far");let t=e.inputBuffer.getChannelData(0);if(16e3!==c.sampleRate)try{t=await async function(e,t){if(console.log("[BellaAI] Resampling from",t,"Hz to 16000 Hz"),16e3===t)return e;const n=16e3/t,o=Math.ceil(e.length*n),a=new OfflineAudioContext(1,o,16e3),i=a.createBuffer(1,e.length,t);i.copyToChannel(e,0);const r=a.createBufferSource();r.buffer=i,r.connect(a.destination),r.start(0);try{return(await a.startRendering()).getChannelData(0)}catch(t){return console.error("[BellaAI] Resampling error:",t),e}}(t,c.sampleRate)}catch(e){console.error("[BellaAI] Resampling error:",e)}const n=function(e){const t=new Int16Array(e.length);for(let n=0;n<e.length;n++){let o=Math.max(-1,Math.min(1,e[n]));t[n]=o<0?32768*o:32767*o}return t}(t),o=function(e){const t=new Uint8Array(e.buffer);let n="";for(let e=0;e<t.byteLength;e++)n+=String.fromCharCode(t[e]);return btoa(n)}(n);s.send(JSON.stringify({user_audio_chunk:o})),x++}}catch(e){console.error("[BellaAI] Error in voice session:",e),S("Error: "+(e.message||"Could not start voice session"))}}()}function J(){try{const e=localStorage.getItem("bellaaiChatSession");if(!e)return[];const t=JSON.parse(e);return t.messages&&Array.isArray(t.messages)?t.messages.map((e=>({role:"user"===e.type?"user":"assistant",content:"user"===e.type?e.content:e.content.replace(/<[^>]*>/g,"")}))):[]}catch(e){return console.error("Error processing chat session messages:",e),[]}}V.textContent='.chat-message.user{background:linear-gradient(135deg,var(--chat--color-primary) 0%,var(--chat--color-secondary) 100%);color:white;align-self:flex-end;box-shadow:0 4px 12px rgba(133,79,255,0.2);border-radius:12px;padding:12px 16px;margin:8px 0;max-width:80%;word-wrap:break-word;font-size:14px;line-height:1.5}.chat-message.bot{background:#ffffff;border:1px solid rgba(133,79,255,0.2);color:#333;align-self:flex-start;box-shadow:0 4px 12px rgba(0,0,0,0.05);border-radius:12px;padding:12px 16px;margin:8px 0;max-width:80%;word-wrap:break-word;font-size:14px;line-height:1.5}.chat-input{display:flex;align-items:center;gap:8px;padding:0;border-top:1px solid #f0f0f0;margin-top:10px;background:none}.chat-input textarea{flex:1 !important;padding:12px !important;border:1px solid rgba(133,79,255,0.2) !important;border-radius:8px !important;resize:none !important;font-family:inherit !important;font-size:14px !important;height:auto !important;min-height:40px !important;max-height:120px !important;width:auto !important;box-sizing:border-box !important;margin-right:8px}.chat-input button[type="submit"]{background:linear-gradient(135deg,var(--chat--color-primary) 0%,var(--chat--color-secondary) 100%);color:white;border:none;border-radius:8px;padding:0 18px;cursor:pointer;font-weight:500;font-size:16px;height:40px;min-width:40px;display:flex;align-items:center;justify-content:center}',document.head.appendChild(V),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(R?z():v.classList.contains("open")&&W())}))}();