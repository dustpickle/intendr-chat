window.BellaAIVoiceWS=null,window.BellaAIVoiceActive=!1,window.BellaAISeenAudio=window.BellaAISeenAudio||new Set,window.BellaAIEarlyAudioBuffer=[],window.BellaAISpeakingFrames=0,window.BellaAIVoiceChatAudio={q:[],audioCtx:null,playing:!1,currentSrc:null,currentGain:null,paused:!1,agentSpeaking:!1,_resumeTimeout:null,_lastB64:null,enqueue(e,t){t?(this.audioCtx=t,this.q.push(e),console.log("[BellaAI][AUDIO] Enqueued audio chunk. Queue length:",this.q.length),this.playing||this.paused||this._playNext()):console.warn("[BellaAI][AUDIO] enqueue: No audio context provided")},_playNext(){if(this.paused)return void console.log("[BellaAI][AUDIO] _playNext: Paused, not playing next chunk");if(window.BellaAITranscriptTracking.abortCurrentResponse)return console.log("[BellaAI][AUDIO] _playNext: Aborting due to interrupt flag"),void this.stop();const e=this.q.shift();if(!e)return this.playing=!1,this.currentSrc=null,this.agentSpeaking=!1,void console.log("[BellaAI][AUDIO] _playNext: Queue empty, agent done speaking");this.playing=!0,console.log("[BellaAI][AUDIO] _playNext: Decoding and playing next chunk"),this._decodeAndBuffer(e,this.audioCtx).then((e=>{if(!this.audioCtx||"closed"===this.audioCtx.state)return console.error("[BellaAI][AUDIO] AudioContext is closed, cannot play audio"),void(this.playing=!1);if(this.currentSrc){try{this.currentSrc.stop(0)}catch(e){}try{this.currentSrc.disconnect()}catch(e){}this.currentSrc=null}const t=this.audioCtx.createBufferSource();t.buffer=e;const n=this.audioCtx.createGain();n.gain.value=1,t.connect(n),n.connect(this.audioCtx.destination),this.currentSrc=t,this.agentSpeaking=!0,console.log("[BellaAI][AUDIO] Starting audio playback, buffer length:",e.length),t.onended=()=>{console.log("[BellaAI][AUDIO] Audio playback ended"),this.agentSpeaking=!1,this.currentSrc=null,this._playNext()};try{t.start(0),console.log("[BellaAI][AUDIO] Audio playback started")}catch(e){console.error("[BellaAI][AUDIO] Error starting audio source:",e),this.currentSrc=null,this.agentSpeaking=!1,this._playNext()}})).catch((e=>{console.error("[BellaAI][AUDIO] Error decoding/playing audio:",e),this.currentSrc=null,this._playNext()}))},_decodeAndBuffer(e,t){return this._lastB64=e,console.log("[BellaAI] Decoding audio chunk, length:",e.length),new Promise(((n,o)=>{try{if(!e||e.length<100)return console.error("[BellaAI] Invalid base64 data in _decodeAndBuffer:",e.length),void o(new Error("Invalid base64 data"));if(!t||"closed"===t.state)return console.error("[BellaAI] Invalid or closed audio context"),void o(new Error("Invalid audio context"));const a=atob(e);console.log("[BellaAI] Decoded binary length:",a.length);const i=new ArrayBuffer(a.length),r=new Uint8Array(i);for(let e=0;e<a.length;e++)r[e]=a.charCodeAt(e);const l=new Int16Array(Math.floor(r.length/2));for(let e=0,t=0;e<r.length-1;e+=2,t++)l[t]=255&r[e]|(255&r[e+1])<<8;console.log("[BellaAI] Created Int16Array with",l.length,"samples");const s=t.createBuffer(1,l.length,16e3),c=s.getChannelData(0);for(let e=0;e<l.length;e++)c[e]=l[e]/32768;console.log("[BellaAI] Successfully created audio buffer"),n(s)}catch(e){console.error("[BellaAI] Error in _decodeAndBuffer:",e),o(e)}}))},pause(){if(this.paused)console.log("[BellaAI][AUDIO] pause: Already paused");else if(this.paused=!0,console.log("[BellaAI][AUDIO] pause: Pausing playback"),this.currentSrc){try{this.currentSrc.stop(0)}catch(e){}this.currentSrc.disconnect(),this.currentSrc.buffer&&this._lastB64&&(this.q.unshift(this._lastB64),console.log("[BellaAI][AUDIO] pause: Pushed last chunk back to queue")),this.currentSrc=null}},resume(){this.paused?(this.paused=!1,console.log("[BellaAI][AUDIO] resume: Resuming playback"),this._playNext()):console.log("[BellaAI][AUDIO] resume: Not paused")},stop(){if(this.currentSrc){try{this.currentSrc.stop(0)}catch(e){}this.currentSrc.disconnect(),this.currentSrc=null,console.log("[BellaAI][AUDIO] stop: Stopped current source")}this.q=[],this.playing=!1,this.paused=!1,this.agentSpeaking=!1,this.audioCtx&&"running"===this.audioCtx.state&&(this.audioCtx.suspend().catch((()=>{})),console.log("[BellaAI][AUDIO] stop: Suspended audio context")),this.audioCtx=null,console.log("[BellaAI][AUDIO] stop: Cleared queue and reset state")}},window.BellaAITranscriptTracking={lastUserTranscriptId:null,lastAgentResponseId:null,processedResponses:new Set,currentConversationId:null,voiceModeAnnounced:!1,defaultGreetingShown:!1,lastResponseText:null,lastAudioId:null,abortCurrentResponse:!1,reset:function(){this.lastUserTranscriptId=null,this.lastAgentResponseId=null,this.processedResponses.clear(),this.currentConversationId=null,this.voiceModeAnnounced=!1,this.defaultGreetingShown=!1,this.lastResponseText=null,this.lastAudioId=null,this.abortCurrentResponse=!1},isResponseProcessed:function(e){return!!e&&(this.processedResponses.has(e)||this.lastAgentResponseId===e)},markResponseProcessed:function(e){e&&(this.lastAgentResponseId=e,this.processedResponses.add(e))}},function(){const e=()=>{try{const e=new(window.AudioContext||window.webkitAudioContext);e.resume().then((()=>e.close())).catch((()=>{})),window.BellaAIVoiceChatAudio&&window.BellaAIVoiceChatAudio.audioCtx&&window.BellaAIVoiceChatAudio.audioCtx.resume().catch((()=>{}))}catch(e){console.log("[BellaAI] Audio context unlock attempt error (non-critical):",e)}};["touchend","touchstart","click","keydown"].forEach((t=>window.addEventListener(t,e,{once:!0,passive:!0})))}(),function(){console.log("ChatVersion:","2.0");let e="";!async function(){try{const t=await fetch("https://api.ipify.org?format=json"),n=await t.json();e=n.ip,console.log("User IP collected for chat")}catch(t){console.error("Error fetching IP:",t),e="unknown"}}();const t={webhook:{url:"",route:""},branding:{logo:"https://cdn-icons-png.flaticon.com/512/5962/5962463.png",name:"Bella : Product Specialist",welcomeText:""},style:{primaryColor:"#003f72",secondaryColor:"#003f72",position:"right",backgroundColor:"#ffffff",fontColor:"#333333"},dealer:{name:"",phone:"",website:"",searchPage:"",provider:""},overtake:!1},n=window.ChatWidgetConfig?{webhook:{...t.webhook,...window.ChatWidgetConfig.webhook},branding:{...t.branding,...window.ChatWidgetConfig.branding},style:{...t.style,...window.ChatWidgetConfig.style},dealer:{...t.dealer,...window.ChatWidgetConfig.dealer},overtake:window.ChatWidgetConfig.overtake||!1,overtakePath:window.ChatWidgetConfig.overtakePath||"/"}:t;if(window.BellaAIChatWidgetInitialized)return;window.BellaAIChatWidgetInitialized=!0;let o=!1;function a(e){try{const t={manuallyClosed:e,timestamp:(new Date).getTime()};localStorage.setItem("bellaaiChatState",JSON.stringify(t))}catch(e){console.error("Error saving chat state:",e)}}function i(){return"undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}))}function r(e){if(!e)return"";const t=/<[a-z][\s\S]*>/i.test(e);return e=e.replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank">$1</a>'),t||(e=e.replace(/(https?:\/\/[^\s<]+)(?![^<]*>)/g,'<a href="$1" target="_blank">Visit Website</a>')),e=(e=(e=e.replace(/\*\*([^*]+)\*\*/g,"<strong>$1</strong>")).replace(/\*([^*]+)\*/g,"<em>$1</em>")).replace(/\n/g,"<br>")}function l(){const e=document.getElementById("thinking-animation");e&&e.remove()}window.initialUtmParameters=function(e){const t={};try{const n=new URL(e),o=new URLSearchParams(n.search),a=["utm_source","utm_medium","utm_campaign","utm_term","utm_content"];a.forEach((function(e){o.has(e)&&(t[e]=o.get(e))}));for(const[e,n]of o.entries())e.startsWith("utm_")&&!a.includes(e)&&(t[e]=n)}catch(e){console.error("Error extracting UTM parameters:",e)}return t}(window.location.href),console.log("Initial UTM Parameters:",window.initialUtmParameters);let s,c="";function d(){if(c)try{const e={sessionId:c,messages:Array.from(A.children).filter((function(e){return e.classList.contains("chat-message")})).map((function(e){return{type:e.classList.contains("user")?"user":"bot",content:e.classList.contains("user")?e.textContent:e.innerHTML}})),inactivityMessageSent:g,promptBubbleShown:y,timestamp:(new Date).getTime(),utmParameters:window.initialUtmParameters||{}};localStorage.setItem("bellaaiChatSession",JSON.stringify(e))}catch(e){console.error("Error saving chat session:",e)}}function p(){try{const e=localStorage.getItem("bellaaiChatSession");if(e){const t=JSON.parse(e),n=(new Date).getTime()-t.timestamp;if(n<864e5)return A.innerHTML="",c=t.sessionId,t.inactivityMessageSent&&(g=!0),t.promptBubbleShown&&(y=!0),t.utmParameters&&(window.initialUtmParameters=t.utmParameters),t.messages&&t.messages.length>0&&t.messages.forEach((function(e){const t=document.createElement("div");t.className="chat-message "+e.type,"user"===e.type?t.textContent=e.content:t.innerHTML=e.content,A.appendChild(t)})),!0;localStorage.removeItem("bellaaiChatSession")}}catch(e){console.error("Error loading saved chat session:",e),localStorage.removeItem("bellaaiChatSession")}return!1}const h=12e4;let u,g=!1;function m(){clearTimeout(s),g||(s=setTimeout((function(){if(v.classList.contains("open")&&c){const e=document.createElement("div");e.className="chat-message bot",e.innerHTML=r("Do you have any questions I can help with?"),A.appendChild(e),A.scrollTop=A.scrollHeight,g=!0,d()}}),h))}let y=!1;function x(){const e=document.getElementById("prompt-bubble");e&&e.remove()}const f=`\n      .bellaai-chat-widget {\n        --chat--color-primary: ${n.style.primaryColor};\n        --chat--color-secondary: ${n.style.secondaryColor};\n        font-family: 'Geist Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n      }\n      .bellaai-chat-widget .chat-container {\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        z-index: 2147483647;\n        width: 380px;\n        height: 600px;\n        background: #ffffff;\n        border-radius: 12px !important;\n        box-shadow: 0 8px 32px rgba(133, 79, 255, 0.15);\n        border: 1px solid rgba(133, 79, 255, 0.2);\n        overflow: hidden;\n        opacity: 0;\n        transform-origin: bottom right;\n        transform: scale(0);\n        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n        pointer-events: none;\n        display: flex;\n        flex-direction: column;\n        visibility: hidden;\n      }\n      @media screen and (max-width: 600px) {\n        .bellaai-chat-widget .chat-container {\n          width: 100%;\n          height: 100%;\n          bottom: 0;\n          right: 0;\n          border-radius: 0;\n          box-shadow: none;\n        }\n        .bellaai-chat-widget .chat-container.position-left {\n          left: 0;\n        }\n      }\n      .bellaai-chat-widget .chat-container.position-left {\n        right: auto;\n        left: 20px;\n        transform-origin: bottom left;\n      }\n      .bellaai-chat-widget .chat-container.open {\n        opacity: 1;\n        transform: scale(1);\n        pointer-events: all;\n        visibility: visible;\n      }\n      .bellaai-chat-widget .brand-header {\n        padding: 16px;\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        border-bottom: 1px solid rgba(133, 79, 255, 0.1);\n        position: relative;\n      }\n      .bellaai-chat-widget .close-button {\n        position: absolute;\n        right: 16px;\n        top: 50%;\n        transform: translateY(-50%);\n        background: none;\n        border: none;\n        cursor: pointer;\n        font-size: 20px;\n        opacity: 0.6;\n      }\n      .bellaai-chat-widget .brand-header img {\n        width: 32px;\n        height: 32px;\n      }\n      .bellaai-chat-widget .brand-header span {\n        font-size: 18px;\n        font-weight: 500;\n      }\n      .bellaai-chat-widget .chat-interface {\n        display: flex;\n        flex-direction: column;\n        height: 100%;\n      }\n      .bellaai-chat-widget .chat-messages {\n        flex: 1;\n        overflow-y: auto;\n        padding: 20px;\n        display: flex;\n        flex-direction: column;\n      }\n      .bellaai-chat-widget .chat-message {\n        padding: 12px 16px;\n        margin: 8px 0;\n        border-radius: 12px;\n        max-width: 80%;\n        word-wrap: break-word;\n        font-size: 14px;\n        line-height: 1.5;\n      }\n      .bellaai-chat-widget .chat-message.user {\n        background: linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%);\n        color: #fff;\n        align-self: flex-end;\n        box-shadow: 0 4px 12px rgba(133, 79, 255, 0.2);\n        border-radius: 12px;\n        padding: 12px 16px;\n        margin: 8px 0;\n        max-width: 80%;\n        word-wrap: break-word;\n        font-size: 14px;\n        line-height: 1.5;\n      }\n      .bellaai-chat-widget .chat-message.bot {\n        background: #ffffff;\n        border: 1px solid rgba(133, 79, 255, 0.2);\n        color: #333;\n        align-self: flex-start;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);\n      }\n      .bellaai-chat-widget .chat-message.bot a {\n        color: var(--chat--color-primary);\n        text-decoration: none;\n        font-weight: 500;\n      }\n      .bellaai-chat-widget .chat-message.bot a:hover {\n        text-decoration: underline;\n      }\n      .bellaai-chat-widget .chat-message.bot a:hover {\n        text-decoration: underline;\n      }\n      .bellaai-chat-widget .chat-input {\n        padding: 16px;\n        border-top: 1px solid rgba(133, 79, 255, 0.1);\n        display: flex;\n        gap: 8px;\n      }\n      .bellaai-chat-widget .chat-input textarea {\n        flex: 1 !important;\n        padding: 12px !important;\n        border: 1px solid rgba(133, 79, 255, 0.2) !important;\n        border-radius: 8px !important;\n        resize: none !important;\n        font-family: inherit !important;\n        font-size: 14px !important;\n        height: auto !important;\n        min-height: 40px !important;\n        max-height: 120px !important;\n        width: auto !important;\n        box-sizing: border-box !important;\n      }\n      .bellaai-chat-widget .chat-input button {\n        background: linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%);\n        color: #fff;\n        border: none;\n        border-radius: 8px;\n        padding: 0 18px;\n        cursor: pointer;\n        font-weight: 500;\n        font-size: 16px;\n        height: 40px;\n        min-width: 40px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n      }\n      .bellaai-chat-widget .chat-input button svg {\n        fill: #fff;\n        stroke: #fff;\n      }\n    .bellaai-chat-widget .chat-toggle {\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      padding: 16px 20px;\n      background: linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%);\n      color: white;\n      border: none;\n      cursor: pointer;\n      box-shadow: 0 4px 12px rgba(133, 79, 255, 0.3);\n      z-index: 2147483647;\n      border-radius: 30px !important;\n      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);\n      opacity: 1;\n      transform: scale(1);\n    }\n    \n    .bellaai-chat-widget .chat-toggle.hidden {\n      opacity: 0;\n      transform: scale(0.8);\n      pointer-events: none;\n    }\n    \n    .bellaai-chat-widget .chat-toggle-content {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      position: relative;\n    }\n    \n    .bellaai-chat-widget .chat-toggle svg {\n      width: 24px;\n      height: 24px;\n      fill: currentColor;\n      color: white;\n    }\n    \n    .bellaai-chat-widget .chat-toggle-text {\n      font-size: 16px;\n      font-weight: 500;\n      white-space: nowrap;\n      line-height: 24px;\n    }\n    \n    .bellaai-chat-widget .online-indicator {\n      position: absolute;\n      top: -20px;\n      right: -4px;\n      width: 12px;\n      height: 12px;\n      background-color: #22c55e;\n      border-radius: 50%;\n      border: 2px solid white;\n      animation: pulse 2s infinite;\n    }\n    \n    @keyframes pulse {\n      0% {\n        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);\n      }\n      70% {\n        box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);\n      }\n      100% {\n        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);\n      }\n    }\n    \n    /* Update mobile styles for online indicator */\n    @media screen and (max-width: 600px) {\n      .bellaai-chat-widget .chat-toggle {\n        width: 60px;\n        height: 60px;\n        padding: 0;\n        justify-content: center;\n      }\n    \n      .bellaai-chat-widget .chat-toggle-text {\n        display: none;\n      }\n      \n      .bellaai-chat-widget .online-indicator {\n        top: -20px;\n        right: -4px;\n      }\n    }\n    \n        .bellaai-chat-widget .chat-toggle.position-left {\n          right: auto;\n          left: 20px;\n        }\n        .bellaai-chat-widget .chat-toggle svg {\n          width: 24px;\n          height: 24px;\n          fill: currentColor;\n        }\n        .bellaai-chat-widget .thinking {\n          display: flex;\n          align-items: center;\n          padding: 12px 16px;\n          margin: 8px 0;\n          border-radius: 12px;\n          max-width: 80%;\n          align-self: flex-start;\n          background: #fff;\n          border: 1px solid rgba(133, 79, 255, 0.2);\n          gap: 8px;\n        }\n        .bellaai-chat-widget .thinking span {\n          color: #666;\n          font-size: 14px;\n        }\n        .bellaai-chat-widget .dots {\n          display: flex;\n          gap: 2px;\n        }\n        .bellaai-chat-widget .dot {\n          height: 8px;\n          width: 8px;\n          background-color: var(--chat--color-primary);\n          border-radius: 50%;\n          display: inline-block;\n          opacity: 0.4;\n          animation: dot-typing 1.4s infinite ease-in-out;\n        }\n        .bellaai-chat-widget .dot:nth-child(1) { animation-delay: 0s; }\n        .bellaai-chat-widget .dot:nth-child(2) { animation-delay: 0.2s; }\n        .bellaai-chat-widget .dot:nth-child(3) { animation-delay: 0.4s; }\n        /* Prompt bubble styles */\n        .bellaai-chat-widget .prompt-bubble {\n          position: absolute;\n          bottom: 90px;\n          right: 10px;\n          background: white;\n          color: var(--chat--color-primary);\n          padding: 8px 14px;\n          border-radius: 18px;\n          font-size: 14px;\n          font-weight: 500;\n          box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);\n          cursor: pointer;\n          z-index: 2147483646;\n          border: 1px solid rgba(133, 79, 255, 0.2);\n          animation: bounce-in 0.5s;\n        }\n        /* Position the prompt bubble on the left if chat is on the left */\n        .bellaai-chat-widget .chat-toggle.position-left + .prompt-bubble {\n          right: auto;\n          left: 10px;\n        }\n        @keyframes bounce-in {\n          0% { transform: scale(0.5); opacity: 0; }\n          50% { transform: scale(1.05); opacity: 0.9; }\n          100% { transform: scale(1); opacity: 1; }\n        }\n        @keyframes dot-typing {\n          0%, 60%, 100% { opacity: 0.4; transform: scale(1); }\n          30% { opacity: 1; transform: scale(1.2); }\n        }\n      `,b=document.createElement("style");b.textContent=f,document.head.appendChild(b);const w=document.createElement("div");w.className="bellaai-chat-widget";const v=document.createElement("div");v.className="chat-container"+("left"===n.style.position?" position-left":"");const k=`\n        <div class="chat-interface">\n          <div class="brand-header">\n            <img src="${n.branding.logo}" alt="${n.branding.name}">\n            <span>${n.branding.name}</span>\n            <button class="close-button">Ã—</button>\n          </div>\n          <div class="chat-messages"></div>\n          <div class="chat-input">\n            <textarea placeholder="Type your message here..." rows="1"></textarea>\n            <button type="submit">Send</button>\n          </div>\n        </div>\n      `;v.innerHTML=k;const I=document.createElement("button");I.className="chat-toggle"+("left"===n.style.position?" position-left":""),I.innerHTML='\n        <div class="chat-toggle-content">\n          <div class="online-indicator"></div>\n          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\n            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" fill="currentColor"/>\n          </svg>\n          <span class="chat-toggle-text">Chat with us!</span>\n        </div>\n      ',"left"!==n.style.position&&(I.style.right="85px"),w.appendChild(v),w.appendChild(I);const C=document.createElement("button");C.className="chat-toggle phone-toggle"+("left"===n.style.position?" position-left":""),C.innerHTML='\n        <div class="chat-toggle-content">\n          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>\n          </svg>\n        </div>\n      ',C.style.position="fixed",C.style.bottom="20px",C.style.right=(n.style.position,"20px"),C.style.width="60px",C.style.height="60px",C.style.borderRadius="50%",C.style.display="flex",C.style.alignItems="center",C.style.justifyContent="center",C.style.background="linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%)",C.style.color="white",C.style.border="none",C.style.cursor="pointer",C.style.boxShadow="0 4px 12px rgba(133, 79, 255, 0.3)",C.style.zIndex="2147483646",C.style.padding="0",C.onclick=function(e){e.stopPropagation();const t=document.getElementById("bellaai-phone-tooltip");if(t)return void t.remove();const o=document.createElement("div");o.id="bellaai-phone-tooltip",o.style.position="fixed",o.style.bottom="90px",o.style.right=(n.style.position,"20px"),o.style.background="white",o.style.boxShadow="0 2px 12px rgba(0,0,0,0.15)",o.style.borderRadius="8px",o.style.padding="10px",o.style.zIndex="2147483646",o.style.width="200px",o.style.boxSizing="border-box";const a=document.createElement("style");a.textContent="\n          #bellaai-phone-tooltip::after {\n            content: '';\n            position: absolute;\n            bottom: -10px;\n            right: 30px;\n            margin-left: -10px;\n            border-width: 10px 10px 0;\n            border-style: solid;\n            border-color: white transparent transparent transparent;\n            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));\n          }\n        ",document.head.appendChild(a),o.innerHTML='\n          <div style="font-size:1.1rem;font-weight:600;margin-bottom:8px;color:#333;">Prefer to talk on the phone?</div>\n          <div style="font-size:0.9rem;color:#666;margin-bottom:12px;">I can ring you now at the number you enter below to make things easier!</div>\n          <div id="bellaai-phone-input-container" style="width:100%;box-sizing:border-box;">\n            <input type="tel" id="bellaai-direct-phone-input" placeholder="Your phone number" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;margin-bottom:6px;font-size:1rem;box-sizing:border-box;">\n            <button id="bellaai-direct-start-call" style="width:100%;padding:10px;border-radius:4px;background:#003f72;color:#fff;font-weight:500;font-size:1rem;border:none;cursor:pointer;box-sizing:border-box;">Start Call</button>\n          </div>\n          <div id="bellaai-direct-call-error" style="color:#c00;margin-top:8px;text-align:center;display:none;"></div>\n        ',document.body.appendChild(o);const i=C.getBoundingClientRect();o.getBoundingClientRect();window.innerWidth<=600?(o.style.width="280px",o.style.right="20px",o.style.left="auto",o.style.transform="none",o.style.bottom="90px",o.style.top="auto"):o.style.right=window.innerWidth-i.right-i.width/2+30+"px",document.addEventListener("click",(function e(t){o.contains(t.target)||t.target===C||(o.remove(),document.removeEventListener("click",e))})),document.getElementById("bellaai-direct-start-call").onclick=async function(){const e=document.getElementById("bellaai-direct-phone-input").value.trim(),t=document.getElementById("bellaai-direct-call-error");if(!e)return t.textContent="Please enter your phone number.",void(t.style.display="block");try{document.getElementById("bellaai-direct-phone-input").disabled=!0,document.getElementById("bellaai-direct-start-call").disabled=!0,document.getElementById("bellaai-direct-start-call").textContent="Connecting...",await $("phone_raw",e),t.style.color="#090",t.textContent="Call initiated! Please answer your phone.",t.style.display="block",setTimeout((()=>{o.remove()}),3e3)}catch(e){t.textContent=e.message||"Couldn't connect your call. Please try again.",t.style.display="block",document.getElementById("bellaai-direct-phone-input").disabled=!1,document.getElementById("bellaai-direct-start-call").disabled=!1,document.getElementById("bellaai-direct-start-call").textContent="Start Call"}}},w.appendChild(C),document.body.appendChild(w);v.querySelector(".chat-interface");const A=v.querySelector(".chat-messages"),S=v.querySelector("textarea"),E=v.querySelector('button[type="submit"]'),T=v.querySelector(".close-button");function B(){const t=window.bellaaiTextarea||S||document.querySelector(".chat-input textarea");if(!t)return void console.error("[BellaAI] No textarea found for message sending");const o=t.value.trim();if(!o)return;if(["close","close chat","exit","quit","dismiss"].includes(o.toLowerCase()))return R?H():W(),void(t.value="");!async function(t){if(!t.trim())return;const o=document.createElement("div");o.className="chat-message user",o.textContent=t,A.appendChild(o),A.scrollTop=A.scrollHeight;!function(){const e=document.createElement("div");e.className="thinking",e.innerHTML='\n        <span>Bella is typing</span>\n        <div class="dots">\n        <div class="dot"></div>\n        <div class="dot"></div>\n        <div class="dot"></div>\n        </div>\n      ',e.id="thinking-animation",A.appendChild(e),A.scrollTop=A.scrollHeight}();try{const o=L||await N(),a={chatInput:t,sessionId:c,metadata:{dealer:n.dealer,pageContext:o,utmParameters:window.initialUtmParameters||{},userIP:e}},i=await fetch(n.webhook.url,{method:"POST",headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"},body:JSON.stringify(a)});if(!i.ok)throw new Error("Failed to send message");let p="";const h=await i.text();try{const e=JSON.parse(h);Array.isArray(e)&&e.length>0&&e[0].output?p=e[0].output:e&&"object"==typeof e?p=e.output||e.response||e.message||"":"string"==typeof e&&(p=e)}catch(e){p=h}p&&""!==p.trim()||(p="I received your message, but I'm having trouble generating a response."),l();const u=p.match(/\[REDIRECT\](.*?)\[\/REDIRECT\]/);if(u&&u[1]){const e=function(e){try{const t=new URL(e),n=new URLSearchParams(t.search);return n.set("utm_source","BellaAI"),n.set("utm_medium","chat"),n.set("utm_campaign","Drivonic-MarketBuilder-AIChat"),t.search=n.toString(),t.toString()}catch(t){return console.error("Error appending UTM parameters to URL:",t),e}}(u[1].trim()),t=p.replace(/\[REDIRECT\][\s\S]*?\[\/REDIRECT\]/g,"").trim();if(t){const e=document.createElement("div");e.className="chat-message bot",e.innerHTML=r(t),A.appendChild(e),A.scrollTop=A.scrollHeight}return void setTimeout((()=>{const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r("Redirecting you now..."),A.appendChild(t),A.scrollTop=A.scrollHeight,d(),setTimeout((()=>{window.location.href=e}),3e3)}),1e3)}const y=p.replace(/\[REDIRECT\][\s\S]*?\[\/REDIRECT\]/g,"").trim();if(y){const e=document.createElement("div");e.className="chat-message bot",e.innerHTML=r(y),A.appendChild(e),A.scrollTop=A.scrollHeight}d(),g=!1,clearTimeout(s),m()}catch(e){console.error("Error sending message:",e),l();const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r("I apologize, but I'm having trouble connecting right now. Please try again in a moment."),A.appendChild(t),A.scrollTop=A.scrollHeight}}(o),t.value="",t.style.height="auto"}I.addEventListener("click",(function(){if(!v.classList.contains("open")){v.classList.add("open"),I.classList.add("hidden"),window.innerWidth<=600&&(document.body.style.overflow="hidden"),A.innerHTML="";p()||(g=!1,c=i(),N().then((()=>{D()}))),d(),A.scrollTop=A.scrollHeight,m(),clearTimeout(u)}})),T.addEventListener("click",(function(){R?H():W(),o=!0,a(!0),window.innerWidth<=600&&(document.body.style.overflow="")})),S.addEventListener("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),E.addEventListener("click",B),S.addEventListener("keypress",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),B())})),window.addEventListener("resize",(function(){window.innerWidth<=600?v.classList.contains("open")&&(document.body.style.overflow="hidden"):document.body.style.overflow=""}));let L=null,z=null;async function N(){try{const e=document.querySelector("main, #main, .main-content, .content");if(!e)return console.log("No main content found on page"),null;const t=function(){const e=localStorage.getItem("bellai_nav_links");if(e)return JSON.parse(e);const t=new Set;function n(e){e&&e.querySelectorAll("a[href]").forEach((e=>{const n=e.getAttribute("href"),o=e.textContent.trim();if(n&&!n.startsWith("#")&&!n.startsWith("javascript:")&&o){const e=new URL(n,window.location.origin).href;t.add(JSON.stringify({text:o,url:e}))}}))}const o=document.querySelector("nav"),a=document.querySelector("header");o&&n(o),a&&n(a),0===t.size&&document.querySelectorAll('[class*="nav"]').forEach((e=>n(e)));const i=Array.from(t).map((e=>JSON.parse(e)));return localStorage.setItem("bellai_nav_links",JSON.stringify(i)),i}(),o=function(){const e=window.location.pathname.toLowerCase();return e.includes("/new-vehicles/")||e.includes("/used-vehicles/")?"inventory":e.includes("/finance")?"finance":e.includes("/service")?"service":e.includes("/parts")?"parts":e.includes("/about")?"about":e.includes("/contact")?"contact":"/"===e||"/index.html"===e?"home":"other"}(),a=function(e){if(!e)return"";const t=e.cloneNode(!0),n=t.getElementsByTagName("script");for(;n.length>0;)n[0].parentNode.removeChild(n[0]);const o=t.getElementsByTagName("style");for(;o.length>0;)o[0].parentNode.removeChild(o[0]);let a=t.textContent||t.innerText;return a=a.replace(/\s+/g," ").trim(),a=a.replace(/<[^>]*>/g,""),a}(e);if(!a)return console.log("No text content found in main content"),null;const i=await async function(e){const t=(new TextEncoder).encode(e),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}(a),r=function(e,t){try{const n=localStorage.getItem("bellaaiPageSummary");if(n){const{url:o,hash:a,summary:i,timestamp:r}=JSON.parse(n);if(o===e&&a===t&&Date.now()-r<36e5)return i}}catch(e){console.error("Error reading cached summary:",e)}return null}(window.location.href,i);if(r)return console.log("Using cached page summary"),{...r,navigationLinks:t};const l={title:document.title,url:window.location.href,description:document.querySelector('meta[name="description"]')?.getAttribute("content")||"",type:o,dealer:n.dealer,navigationLinks:t},s=new URLSearchParams({content:a,metadata:JSON.stringify(l)}),c=await fetch("https://automation.cloudcovehosting.com/webhook/pagecontext?"+s.toString(),{method:"GET",headers:{"Content-Type":"application/json",Origin:window.location.origin}});if(!c.ok)return console.warn("Failed to generate page summary:",c.status,c.statusText),null;const d=await c.text();return d?(function(e,t,n){try{const o={url:e,hash:t,summary:n,timestamp:Date.now()};localStorage.setItem("bellaaiPageSummary",JSON.stringify(o))}catch(e){console.error("Error caching summary:",e)}}(window.location.href,i,d),{summary:d,navigationLinks:t}):(console.warn("Empty response from page context webhook"),null)}catch(e){return console.error("Error generating page summary:",e),null}}function O(){z&&clearTimeout(z),z=setTimeout((async()=>{L=await N()}),1e3)}document.addEventListener("DOMContentLoaded",O);const P=window.location.href;function D(){[`Hi I am Bella, I am here to make your online shopping experience with ${n.dealer.name||"[DealerName]"} easy, but most of all save your time and money. Are you here to find a new vehicle or service your current one?`].forEach(((e,t)=>{setTimeout((()=>{const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r(e),A.appendChild(t),A.scrollTop=A.scrollHeight,d()}),1e3*t)}))}new MutationObserver((()=>{const e=window.location.href;e!==P&&(P=e,O())})).observe(document,{subtree:!0,childList:!0});let R=null;function H(){R&&(w.appendChild(v),R.remove(),R=null),v.classList.remove("overtake-modal"),v.style.position="",v.style.left="",v.style.top="",v.style.transform="",v.style.zIndex="",v.style.width="",v.style.height="",v.style.maxHeight="",v.style.borderRadius="",v.style.boxShadow="",v.style.opacity="",v.style.background="",v.style.display="",v.style.flexDirection="",v.style.padding="",document.body.style.overflow="",W()}const U=document.createElement("style");U.textContent='\n        @keyframes bellaai-fadein {\n          from { opacity: 0; }\n          to { opacity: 1; }\n        }\n        .bellaai-overtake-overlay {\n          animation: bellaai-fadein 0.4s forwards;\n        }\n        .overtake-modal .brand-header {\n          padding-bottom: 12px;\n          border-bottom: 1px solid #f0f0f0;\n          margin-bottom: 12px;\n        }\n        .overtake-modal .brand-header img {\n          width: 40px;\n          height: 40px;\n          margin-right: 10px;\n        }\n        .overtake-modal .brand-header span {\n          font-size: 22px;\n          font-weight: 600;\n        }\n        .overtake-modal .close-button {\n          position: absolute;\n          right: 18px;\n          top: 18px;\n          background: none;\n          border: none;\n          cursor: pointer;\n          font-size: 28px;\n          color: #888;\n          opacity: 0.7;\n          z-index: 2;\n          transition: opacity 0.2s;\n        }\n        .overtake-modal .close-button:hover {\n          opacity: 1;\n        }\n        .overtake-modal .chat-messages {\n          display: flex;\n          flex-direction: column;\n          flex: 1 1 0%;\n          overflow-y: auto;\n          padding: 10px 0 10px 0;\n          margin-bottom: 10px;\n          background: none;\n          min-height: 400px;\n        }\n        .overtake-modal .chat-input {\n          padding: 0;\n          border-top: 1px solid #f0f0f0;\n          margin-top: 10px;\n          background: none;\n          display: flex;\n          align-items: center;\n        }\n        .overtake-modal .chat-input textarea {\n          flex: 1 !important;\n          padding: 12px !important;\n          border: 1px solid rgba(133, 79, 255, 0.2) !important;\n          border-radius: 8px !important;\n          resize: none !important;\n          font-family: inherit !important;\n          font-size: 14px !important;\n          height: auto !important;\n          min-height: 40px !important;\n          max-height: 120px !important;\n          width: auto !important;\n          box-sizing: border-box !important;\n          margin-right: 8px;\n        }\n        .overtake-modal .chat-input button[type="submit"] {\n          background: linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%);\n          color: #fff;\n          border: none;\n          border-radius: 8px;\n          padding: 0 18px;\n          cursor: pointer;\n          font-weight: 500;\n          font-size: 16px;\n          height: 40px;\n          min-width: 40px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        }\n        .overtake-modal .chat-input button[type="submit"] svg {\n          fill: #fff;\n          stroke: #fff;\n        }\n        .overtake-modal .chat-message.user {\n          background: linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%);\n          color: #fff;\n          align-self: flex-end;\n          text-align: right;\n          margin-left: auto;\n          margin-right: 0;\n          box-shadow: 0 4px 12px rgba(133, 79, 255, 0.2);\n          border-radius: 12px;\n          padding: 12px 16px;\n          margin: 8px 0;\n          max-width: 80%;\n          word-wrap: break-word;\n          font-size: 14px;\n          line-height: 1.5;\n        }\n        .overtake-modal #bellaai-voice-button {\n          background: linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%);\n        }\n        @media (max-width: 600px) {\n          .overtake-modal {\n            padding: 0 !important;\n          }\n          .overtake-modal .brand-header img {\n            width: 32px;\n            height: 32px;\n          }\n          .overtake-modal .brand-header span {\n            font-size: 18px;\n          }\n          .overtake-modal .chat-messages {\n            min-height: 200px;\n          }\n        }\n        .chat-container.overtake-modal {\n          height: 100% !important;\n        }\n        .chat-interface {\n          height: 100%;\n          display: flex;\n          flex-direction: column;\n          justify-content: space-around;\n        }\n        .overtake-modal {\n          height: 60vh;\n          max-height: 60vh;\n          display: flex;\n          flex-direction: column;\n        }\n        .overtake-modal .chat-messages {\n          flex: 1 1 0%;\n          overflow-y: auto;\n          min-height: 0;\n        }\n        @media (max-width: 600px) {\n          .overtake-modal {\n            height: 85vh !important;\n            max-height: 85vh !important;\n          }\n        }\n      ',document.head.appendChild(U);const M=document.createElement("style");function _(){x(),y=!0,v.classList.add("open"),I.classList.add("hidden"),window.innerWidth<=600&&(document.body.style.overflow="hidden"),A.scrollTop=A.scrollHeight,m(),clearTimeout(u)}function W(){v.classList.remove("open"),I.classList.remove("hidden"),window.innerWidth<=600&&(document.body.style.overflow="")}function q(){const e=v.querySelector(".chat-input");if(!e)return;e.innerHTML="";const t=document.createElement("button");t.type="button",t.title="Transfer to Phone",t.id="bellaai-voice-button",t.innerHTML='\n          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>\n          </svg>\n        ',t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="center",t.style.background="linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%)",t.style.color="white",t.style.border="none",t.style.borderRadius="8px",t.style.padding="0 12px",t.style.cursor="pointer",t.style.fontWeight="500",t.style.fontSize="16px",t.style.height="40px",t.style.minWidth="40px",t.style.marginRight="8px",t.onclick=function(n){n.stopPropagation();const o=document.getElementById("bellaai-voice-tooltip");if(o)return void o.remove();const a=document.createElement("div");a.id="bellaai-voice-tooltip",a.style.position="absolute",a.style.bottom="60px",a.style.left="0",a.style.background="white",a.style.boxShadow="0 2px 12px rgba(0,0,0,0.15)",a.style.borderRadius="8px",a.style.padding="10px",a.style.zIndex="9999",a.style.width="200px",a.style.boxSizing="border-box";const i=document.createElement("style");i.textContent="\n            #bellaai-voice-tooltip::after {\n              content: '';\n              position: absolute;\n              bottom: -10px;\n              left: 15px;\n              margin-left: -10px;\n              border-width: 10px 10px 0;\n              border-style: solid;\n              border-color: white transparent transparent transparent;\n              filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));\n            }\n          ",document.head.appendChild(i),a.innerHTML='\n            <div style="font-size:1.1rem;font-weight:600;margin-bottom:8px;color:#333;">Prefer to talk on the phone?</div>\n            <div style="font-size:0.9rem;color:#666;margin-bottom:12px;">I can ring you now at the number you enter below to make things easier!</div>\n            <div id="bellaai-phone-input-container" style="width:100%;box-sizing:border-box;">\n              <input type="tel" id="bellaai-direct-phone-input" placeholder="Your phone number" style="width:100%;padding:10px;border-radius:4px;border:1px solid #ccc;margin-bottom:6px;font-size:1rem;box-sizing:border-box;">\n              <button id="bellaai-direct-start-call" style="width:100%;padding:10px;border-radius:4px;background:#003f72;color:#fff;font-weight:500;font-size:1rem;border:none;cursor:pointer;box-sizing:border-box;">Start Call</button>\n            </div>\n            <div id="bellaai-direct-call-error" style="color:#c00;margin-top:8px;text-align:center;display:none;"></div>\n          ',e.style.position="relative",e.appendChild(a),document.addEventListener("click",(function e(n){a.contains(n.target)||n.target===t||(a.remove(),document.removeEventListener("click",e))})),document.getElementById("bellaai-direct-start-call").onclick=async function(){const e=document.getElementById("bellaai-direct-phone-input").value.trim();if(e)try{a.remove(),await $("phone",e);const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r("I'm calling your phone now. Please answer to continue our conversation."),A.appendChild(t),A.scrollTop=A.scrollHeight}catch(e){console.error("Error initiating phone call:",e);const t=document.createElement("div");t.className="chat-message bot",t.innerHTML=r("I couldn't connect to your phone. Please check the number and try again."),A.appendChild(t),A.scrollTop=A.scrollHeight}}};const n=document.createElement("textarea");n.placeholder="Type your message here...",n.rows=1,n.style.resize="none",n.style.flex="1",n.style.marginRight="8px",n.className=S.className;const o=document.createElement("button");o.type="submit",o.innerHTML='<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>',o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.background="linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%)",o.style.color="white",o.style.border="none",o.style.borderRadius="8px",o.style.padding="0 18px",o.style.cursor="pointer",o.style.fontWeight="500",o.style.fontSize="16px",o.style.height="40px",o.style.minWidth="40px",e.appendChild(t),e.appendChild(n),e.appendChild(o),o.addEventListener("click",B),n.addEventListener("keypress",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),B())})),n.addEventListener("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),window.bellaaiTextarea=n}M.textContent="\n        .overtake-modal {\n          width: 800px !important;\n          max-width: 95vw;\n        }\n        @media (max-width: 900px) {\n          .overtake-modal {\n            width: 95vw !important;\n          }\n        }\n        @media (max-width: 600px) {\n          .overtake-modal {\n            width: 95vw !important;\n            height: 85vh !important;\n            max-height: 85vh !important;\n            border-radius: 12px !important;\n            padding: 16px 6px 10px 6px !important;\n          }\n        }\n      ",document.head.appendChild(M),function(){const e=n.overtakePath||"/";return!0===n.overtake&&window.location.pathname===e&&!localStorage.getItem("bellaaiOvertakeShown")}()&&setTimeout((()=>{R=document.createElement("div"),R.className="bellaai-overtake-overlay",R.style.position="fixed",R.style.inset="0",R.style.background="rgba(0,0,0,0.6)",R.style.zIndex="2147483646",R.style.display="flex",R.style.alignItems="center",R.style.justifyContent="center",R.style.transition="opacity 0.4s",R.style.opacity="0",R.style.animation="bellaai-fadein 0.4s forwards",v.classList.add("overtake-modal"),v.style.position="relative",v.style.left="",v.style.top="",v.style.transform="",v.style.zIndex="2147483647",v.style.width="800px",v.style.height="auto",v.style.maxHeight="90vh",v.style.borderRadius="18px",v.style.boxShadow="0 8px 32px rgba(0,0,0,0.25)",v.style.opacity="0",v.style.background="#fff",v.style.display="flex",v.style.flexDirection="column",v.style.padding="32px 28px 20px 28px",v.style.transition="opacity 0.4s",v.style.setProperty("--chat--color-primary",n.style.primaryColor),v.style.setProperty("--chat--color-secondary",n.style.secondaryColor),setTimeout((()=>{v.style.opacity="1"}),50),window.innerWidth<=900&&(v.style.width="95vw"),window.innerWidth<=600&&(v.style.width="95vw",v.style.height="85vh",v.style.maxHeight="85vh",v.style.borderRadius="12px",v.style.padding="16px 6px 10px 6px"),I.classList.add("hidden"),document.body.appendChild(R),R.appendChild(v),document.body.style.overflow="hidden",localStorage.setItem("bellaaiOvertakeShown","1"),_()}),400),function(){if(window.BellaAIChatWidgetChatInitialized)return;window.BellaAIChatWidgetChatInitialized=!0,p()||(g=!1,c=i(),D(),N()),d(),A.scrollTop=A.scrollHeight,m(),clearTimeout(u),I.addEventListener("click",(function(){_()})),T.addEventListener("click",(function(){W(),o=!0,a(!0),window.innerWidth<=600&&(document.body.style.overflow="")})),E.addEventListener("click",B),S.addEventListener("keypress",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),B())})),S.addEventListener("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),window.addEventListener("resize",(function(){window.innerWidth<=600?v.classList.contains("open")&&(document.body.style.overflow="hidden"):document.body.style.overflow=""}))}(),q();const j=document.createElement("style");function J(){try{const e=localStorage.getItem("bellaaiChatSession");if(!e)return[];const t=JSON.parse(e);return t.messages&&Array.isArray(t.messages)?t.messages.map((e=>({role:"user"===e.type?"user":"assistant",content:"user"===e.type?e.content:e.content.replace(/<[^>]*>/g,""),timestamp:(new Date).toISOString()}))):[]}catch(e){return console.error("Failed to parse chat history",e),[]}}async function $(e,t){const o=J(),a=n.dealer;console.log("[BellaAI] Initiating voice call with dealer info:",a);let i="";try{const e=n.webhook.url.match(/\/webhook\/([^\/]+)/);e&&e[1]&&(i=e[1],i=i.replace(/\/chat$/,""))}catch(e){console.error("[BellaAI] Error extracting chatbot ID:",e)}let r={};if("phone_raw"===e)r={type:e,phone:t,chatbotId:i,dealerInfo:a};else if(r={type:e,chatHistory:o,dealerInfo:a,sessionId:c,chatbotId:i},"phone"===e){if(!t)throw new Error("Phone number required for phone call");r.phone=t}try{console.log("[BellaAI] Sending voice call payload:",JSON.stringify(r));const e=await fetch("https://automation.cloudcovehosting.com/webhook/voice-call",{method:"POST",headers:{"Content-Type":"application/json","Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type"},body:JSON.stringify(r)});if(!e.ok){const t=await e.text();throw new Error("Failed to initiate call: "+t)}const n=e.headers.get("content-type");if(n&&n.includes("application/json"))return e.json();return{status:"success",message:await e.text(),callDetails:{phone:t,callId:"unknown",status:"connecting"}}}catch(e){throw console.error("Error in initiateVoiceCall:",e),e}}j.textContent='\n        .chat-message.user {\n          background: linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%);\n          color: white;\n          align-self: flex-end;\n          box-shadow: 0 4px 12px rgba(133, 79, 255, 0.2);\n          border-radius: 12px;\n          padding: 12px 16px;\n          margin: 8px 0;\n          max-width: 80%;\n          word-wrap: break-word;\n          font-size: 14px;\n          line-height: 1.5;\n        }\n        .chat-message.bot {\n          background: #ffffff;\n          border: 1px solid rgba(133, 79, 255, 0.2);\n          color: #333;\n          align-self: flex-start;\n          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);\n          border-radius: 12px;\n          padding: 12px 16px;\n          margin: 8px 0;\n          max-width: 80%;\n          word-wrap: break-word;\n          font-size: 14px;\n          line-height: 1.5;\n        }\n        .chat-input {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          padding: 0;\n          border-top: 1px solid #f0f0f0;\n          margin-top: 10px;\n          background: none;\n        }\n        .chat-input textarea {\n          flex: 1 !important;\n          padding: 12px !important;\n          border: 1px solid rgba(133, 79, 255, 0.2) !important;\n          border-radius: 8px !important;\n          resize: none !important;\n          font-family: inherit !important;\n          font-size: 14px !important;\n          height: auto !important;\n          min-height: 40px !important;\n          max-height: 120px !important;\n          width: auto !important;\n          box-sizing: border-box !important;\n          margin-right: 8px;\n        }\n        .chat-input button[type="submit"] {\n          background: linear-gradient(135deg, var(--chat--color-primary) 0%, var(--chat--color-secondary) 100%);\n          color: white;\n          border: none;\n          border-radius: 8px;\n          padding: 0 18px;\n          cursor: pointer;\n          font-weight: 500;\n          font-size: 16px;\n          height: 40px;\n          min-width: 40px;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        }\n      ',document.head.appendChild(j),document.addEventListener("keydown",(function(e){"Escape"===e.key&&(R?H():v.classList.contains("open")&&W())}))}();